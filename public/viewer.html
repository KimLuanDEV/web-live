<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta
  name="viewport"
  content="width=device-width,
           initial-scale=1,
           maximum-scale=1,
           minimum-scale=1,
           user-scalable=no"
/>

  <title>Viewer - Livestream Pro</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>



  
  <div class="container">
    <div class="card">

      
      <div class="page-header">
  <h1 class="page-title">ğŸ‘ Viewer</h1>

  <span class="status-badge status-live" id="statusBadge">
    ğŸ”´ LIVE
  </span>

  <button id="btnBackLobby" class="page-exit-btn" title="Quay vá» Lobby">
    ğŸšª
  </button>
</div>



      <hr />

      <div class="row">

        <div class="card" style="display: none;">
          <div class="kv">
            <div class="badge">PhÃ²ng Livestream</div>
            <code id="roomCode">-</code>
            <button id="btnJoin">Tham gia xem Livestream</button>
          </div>

          <hr />
          <div class="log" id="log" style="display: none;"></div>
        </div>

       

        <div class="live-stage" id="liveStage" style="margin-top:10px">

          <div class="gift-layer" id="giftLayer"></div>

  <!-- HOST -->
  <div class="video-card live-main" id="hostCard">
    <div class="live-overlay">
      <span class="dot"></span>
      <b>LIVE</b>
      <span class="live-meta">
        <span class="meta-item" id="viewerCountViewer">ğŸ‘ 0</span>
        <span class="meta-sep">â€¢</span>
        <span class="meta-item" id="liveTimerViewer">â± 00:00:00</span>
      </span>
    </div>
<div class="chat-overlay" id="chatOverlay"></div>

<!-- CHAT QUICK BUTTON -->
<button class="chat-fab" id="chatFab">ğŸ’¬</button>

<!-- REQUEST LIVE ICON -->
<button class="req-live-fab" id="btnRequestLive" title="Xin lÃªn live">ğŸ¤</button>


<!-- CHAT INPUT OVERLAY -->
<div class="chat-input-overlay hidden" id="chatInputOverlay">
  <input
    id="quickChatInput"
    placeholder="Nháº­p tin nháº¯n..."
    autocomplete="off"
  />
  <button id="quickChatSend">â¤</button>
</div>


<div class="join-overlay" id="joinOverlayViewer" aria-live="polite"></div>
<div class="pin-overlay" id="pinOverlay"></div>

        <div class="reactions-layer" id="reactionsLayerViewer"></div>
<div class="video-card__inner">
      <video id="player" autoplay playsinline></video>
    </div>

<!-- GIFT FLOAT BUTTON -->
<button class="gift-fab" id="giftFab" title="Táº·ng quÃ ">ğŸ</button>

<!-- GIFT PANEL -->
<div class="gift-panel hidden" id="giftPanel">
  <div class="gift-panel__title">ğŸ Táº·ng quÃ </div>

<!-- âœ… VÃ­ - Coins NGAY TRONG PANEL -->
  <div class="gift-wallet">
  <div class="gift-wallet__row">
    <span class="gift-wallet__label">VÃ­ coin:</span>
    <b id="walletCoins">0</b>
    <span class="gift-wallet__unit">coin</span>
  </div>
  

 <!-- âœ… COMBO NGAY TRONG PANEL -->
  <div class="gift-combo" id="giftCombo">
    <span class="gift-combo__label">Combo:</span>
    <button type="button" class="gift-combo__btn is-active" data-combo="1">x1</button>
    <button type="button" class="gift-combo__btn" data-combo="5">x5</button>
    <button type="button" class="gift-combo__btn" data-combo="10">x10</button>
  </div>

  <!-- âœ… QÃ™A NGAY TRONG PANEL -->
  <div class="gift-panel__grid">
    <button data-gift="heart">â¤ï¸</button>
    <button data-gift="flower">ğŸŒ¸</button>
    <button data-gift="rocket">ğŸš€</button>
    <button data-gift="coin">ğŸ’°</button>
    <button data-gift="dragon">ğŸ‰</button>
    <button data-gift="phoenix">ğŸ¦…</button>
    <button data-gift="galaxy">ğŸŒŒ</button>
    <button data-gift="meteor">â˜„ï¸</button>
    <button data-gift="king">ğŸ‘‘</button>
    <button data-gift="dragonking">ğŸ²</button>
    <button data-gift="supernova">ğŸŒ </button>
  </div>
</div>



  </div>

  <!-- GUEST (PIP) -->
  <div class="pip-wrap" id="guestPipWrap" aria-hidden="true">
    <div class="pip-badge">ğŸ‘¤ GUEST</div>
    <video id="guestPlayer" autoplay playsinline></video>
  </div>
</div>


        </div>
      


    </div>
  </div>

<hr />
<div class="card chat" style="display: none;">
  <div class="badge badge--info">ğŸ’¬ Chat (Live)</div>

  <div class="chatform">
    <input id="chatName" placeholder="TÃªn cá»§a báº¡n" />
    <input id="chatText" placeholder="Nháº­p tin nháº¯n..." />
    <button id="chatSend" class="full">Gá»­i</button>
  </div>

   <div class="emoji-bar" id="emojiBar" style="display: none;">
      <button type="button" class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸</button>
      <button type="button" class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
      <button type="button" class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
      <button type="button" class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
      <button type="button" class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
      <button type="button" class="emoji-btn" data-emoji="ğŸ˜®">ğŸ˜®</button>
      <button type="button" class="emoji-btn" data-emoji="ğŸ˜¢">ğŸ˜¢</button>
    </div>

  <div class="gift-bar">
  <button data-gift="heart">â¤ï¸</button>
  <button data-gift="flower">ğŸŒ¸</button>
  <button data-gift="rocket">ğŸš€</button>
  <button data-gift="coin">ğŸ’°</button>
  <button data-gift="dragon">ğŸ‰</button>
  <button data-gift="phoenix">ğŸ¦…</button>
  <button data-gift="galaxy">ğŸŒŒ</button>
  <button data-gift="meteor">â˜„ï¸</button>
  <button data-gift="king">ğŸ‘‘</button>
  <button data-gift="dragonking">ğŸ²</button>
  <button data-gift="supernova">ğŸŒ </button>
</div>

</div>


 

  <div class="gift-board">
    <div class="gift-board__head">ğŸ† Top donate</div>
    <div class="gift-board__meta">Tá»•ng: <b id="giftTotalCoins">0</b> coin</div>
    <div id="giftTopList" class="gift-board__list"></div>
  </div>
</div>



  <div id="chatBox" class="chatbox"></div>
</div>


<!-- NEON CONFIRM (Back to Lobby) -->
<div id="neonConfirm" class="ncf hidden" aria-hidden="true">
  <div class="ncf__bg"></div>

  <div class="ncf__box" role="dialog" aria-modal="true" aria-labelledby="ncfTitle">
    <div class="ncf__frame"></div>
    <div class="ncf__scan"></div>

    <div class="ncf__top">
      <div class="ncf__pill">
        <span class="ncf__dot"></span>
        <span>Rá»œI PHÃ’NG XEM</span>
      </div>
      <button class="ncf__x" id="ncfX" type="button" aria-label="ÄÃ³ng">âœ•</button>
    </div>

    <h3 id="ncfTitle" class="ncf__title">Quay vá» Lobby?</h3>

    <div class="ncf__desc">
      <div class="ncf__row">â€¢ Báº¡n sáº½ rá»i khá»i phÃ²ng Ä‘ang xem</div>
      <div class="ncf__row">â€¢ CÃ³ thá»ƒ vÃ o láº¡i tá»« Lobby báº¥t ká»³ lÃºc nÃ o</div>
    </div>

    <div class="ncf__actions">
      <button id="ncfCancel" class="ncf__btn ncf__btn--ghost" type="button">á» láº¡i</button>
      <button id="ncfOk" class="ncf__btn ncf__btn--main" type="button">âœ… Vá» Lobby</button>
    </div>
  </div>
</div>


<!-- ğŸ GIFT CONFIRM MODAL â€“ ULTRA NEON -->
<div id="giftConfirmModal" class="gcm hidden" aria-hidden="true">
  <div class="gcm-bg"></div>

  <div class="gcm-box">
    <div class="gcm-glow"></div>
    <div class="gcm-scan"></div>

    <div class="gcm-head">
      <div class="gcm-pill">
        <span class="dot"></span>
        <span>XÃC NHáº¬N Táº¶NG QUÃ€</span>
      </div>
      <button class="gcm-close" id="gcmClose">âœ•</button>
    </div>

    <div class="gcm-body">
      <!-- GIFT ICON -->
      <div class="gcm-gift">
        <div class="gcm-gift-ring"></div>
        <div class="gcm-gift-emoji" id="gcmEmoji">ğŸ</div>
        <div class="gcm-gift-name" id="gcmTitle">Supernova</div>
      </div>

      <!-- INFO -->
      <div class="gcm-info">
        <div class="gcm-row">
          <span>GiÃ¡ / quÃ </span>
          <b><span id="gcmCost">0</span> coin</b>
        </div>
        <div class="gcm-row">
          <span>Combo</span>
          <b id="gcmQty">x1</b>
        </div>
        <div class="gcm-row total">
          <span>Tá»•ng trá»«</span>
          <b id="gcmTotal">0 coin</b>
        </div>
      </div>

      <div class="gcm-wallet">
        ğŸ’¼ VÃ­ hiá»‡n táº¡i: <b id="gcmWallet">0</b> coin
      </div>
    </div>

    <div class="gcm-actions">
      <button class="gcm-btn cancel" id="gcmCancel">Há»§y</button>
      <button class="gcm-btn send" id="gcmOk">
        ğŸ Gá»¬I QUÃ€
      </button>
    </div>
  </div>
</div>

<!-- ğŸš« NOT ENOUGH COIN MODAL -->
<div id="coinErrorModal" class="cem hidden" aria-hidden="true">
  <div class="cem-bg"></div>

  <div class="cem-box" role="dialog" aria-modal="true">
    <div class="cem-glow"></div>

    <div class="cem-head">
      <div class="cem-pill">
        <span class="dot"></span>
        <span>KHÃ”NG Äá»¦ COIN</span>
      </div>
      <button class="cem-close" id="cemClose">âœ•</button>
    </div>

    <div class="cem-body">
      <div class="cem-icon">ğŸ’¸</div>
      <div class="cem-text">
        VÃ­ cá»§a báº¡n <b>khÃ´ng Ä‘á»§ coin</b><br />
        Ä‘á»ƒ thá»±c hiá»‡n giao dá»‹ch nÃ y.
      </div>

      <div class="cem-wallet">
        VÃ­ hiá»‡n táº¡i: <b id="cemWallet">0</b> coin
      </div>
    </div>

    <div class="cem-actions">
      <button id="cemOk" class="cem-btn">ÄÃ£ hiá»ƒu</button>
    </div>
  </div>
</div>


<!-- ğŸ”„ RECONNECT OVERLAY -->
<div id="reconnectOverlay" class="reconnect-overlay hidden">
  <div class="reconnect-box">
    <div class="reconnect-spinner"></div>
    <div class="reconnect-text">Äang káº¿t ná»‘i láº¡iâ€¦</div>
  </div>
</div>


  <script src="/socket.io/socket.io.js"></script>
  <script>
    const logEl = document.getElementById("log");
    const badge = document.getElementById("statusBadge");
    const player = document.getElementById("player");
    const guestPlayer = document.getElementById("guestPlayer");
    const btnJoin = document.getElementById("btnJoin");
    const liveStage = document.getElementById("liveStage");
    const guestPipWrap = document.getElementById("guestPipWrap");
    const params = new URLSearchParams(location.search);
    const roomId = params.get("room") || "abc123";

let __viewerWasBackground = false;
let __viewerAutoReloaded = false;

    document.getElementById("roomCode").textContent = roomId;

// ===== AUTO RECOVER AUDIO/VIDEO (VIEWER) =====
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    console.warn("ğŸ‘€ Viewer background â†’ mark resume");
    __viewerNeedResume = true;
  }
});

window.addEventListener("focus", () => {
  if (!__viewerWasBackground) return;
  if (__viewerReloading) return;

  __viewerReloading = true;

  const overlay = document.getElementById("reconnectOverlay");
  if (overlay) overlay.classList.remove("hidden");

  console.warn("ğŸ”„ Viewer resume â†’ show overlay & reload");

  // delay nháº¹ cho mÆ°á»£t
  setTimeout(() => {
    // reload sáº¡ch, khÃ´ng back history
    location.replace(location.href);
  }, 700);
});

function clearGuestView(reason = "") {
  console.warn("ğŸ‘‹ Guest left â†’ clear PIP", reason);

  guestId = null;

  // stop & clear guest video
  try {
    if (guestPlayer?.srcObject) {
      guestPlayer.srcObject.getTracks().forEach(t => t.stop());
    }
  } catch {}

  if (guestPlayer) {
    guestPlayer.pause();
    guestPlayer.srcObject = null;
  }

  // hide PIP
  if (guestPipWrap) {
    guestPipWrap.style.display = "none";
    guestPipWrap.classList.remove("is-speaking");
  }

  // remove global state
  document.body.classList.remove("has-guest");
}


     let swapped = false; // false: host main, true: guest main


    const socket = io();

socket.on("host-back-online", () => {
  console.warn("ğŸ”” Host back online â†’ try rejoin");

  if (!joined) {
    setTimeout(() => {
      join().catch(e => console.error("Rejoin on host-back failed", e));
    }, 300);
  }
});

    socket.on("broadcaster-online", () => {
  console.warn("ğŸ“¡ Broadcaster online â†’ force join");

  // trÃ¡nh join láº·p
  if (joined) return;

  join().catch(e => console.error("Join on broadcaster-online failed", e));
});



// ===== VIP TICKER + CHAT FREEZE + FIREWORKS =====
const vipTicker = document.getElementById("vipTicker");
let __vipQueue = [];
let __vipBusy = false;

function showVipTicker(text, ms){
  try{
    if (!vipTicker) return;
    const item = document.createElement("div");
    item.className = "vip-ticker__item";
    item.textContent = text;
    vipTicker.appendChild(item);
    // auto remove after animation
    setTimeout(()=>{ try{ item.classList.add("hide"); }catch{} }, Math.max(0, ms-350));
    setTimeout(()=>{ try{ item.remove(); }catch{} }, ms+200);
  }catch{}
}

function enqueueVip(text, ms=3000){
  __vipQueue.push({ text, ms });
  if (!__vipBusy) runVipQueue();
}

function runVipQueue(){
  if (__vipBusy) return;
  const next = __vipQueue.shift();
  if (!next) return;
  __vipBusy = true;
  showVipTicker(next.text, next.ms);
  setTimeout(()=>{
    __vipBusy = false;
    runVipQueue();
  }, next.ms + 120);
}

function freezeChat(ms=1000){
  try{
    document.body.classList.add("chat-frozen");
    setTimeout(()=>{ try{document.body.classList.remove("chat-frozen");}catch{} }, ms);
  }catch{}
}

function startVipSpotlight(ms=1200){
  try{
    // add overlay class
    document.body.classList.add("vip-spotlight");
    // zoom main card if exists
    const card = document.getElementById("hostCard") || document.getElementById("hostCardGuest");
    if (card) card.classList.add("vip-zoom");
    // remove
    setTimeout(()=>{
      try{
        document.body.classList.remove("vip-spotlight");
        if (card) card.classList.remove("vip-zoom");
      }catch{}
    }, ms);
  }catch{}
}

function spawnFireworksBurst(){
  try{
    const layer = document.createElement("div");
    layer.className = "vip-fireworks";
    document.body.appendChild(layer);

    const n = 18;
    for (let i=0;i<n;i++){
      const p = document.createElement("div");
      p.className = "vip-fireworks__p";
      p.style.left = (50 + (Math.random()*18-9))+"%";
      p.style.top  = (22 + (Math.random()*18-9))+"%";
      p.style.setProperty("--dx", (Math.random()*360-180)+"px");
      p.style.setProperty("--dy", (Math.random()*340-220)+"px");
      p.style.setProperty("--rot",(Math.random()*160-80)+"deg");
      p.style.setProperty("--sc",(Math.random()*0.9+0.7));
      layer.appendChild(p);
    }

    setTimeout(()=>{ try{layer.remove();}catch{} }, 1600);
  }catch{}
}
// ===== /VIP TICKER =====
// ===== AUTO SPEAKING HIGHLIGHT (Voice Activity) =====
function attachSpeakingIndicator(videoEl, targetEl){
  try{
    if (!videoEl || !targetEl) return;
    let ctx = null, src = null, analyser = null, data = null, raf = 0;
    let speaking = false;
    let lastOn = 0;

    function start(){
      const st = videoEl.srcObject;
      if (!st) return;
      const at = st.getAudioTracks && st.getAudioTracks()[0];
      if (!at) return; // no audio -> skip

      ctx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = ctx.createAnalyser();
      analyser.fftSize = 512;
      data = new Uint8Array(analyser.frequencyBinCount);

      src = ctx.createMediaStreamSource(new MediaStream([at]));
      src.connect(analyser);

      const TH = 16; // threshold 0..255 (tuning)
      const HOLD_MS = 450;

      const loop = ()=>{
        if (!analyser) return;
        analyser.getByteFrequencyData(data);
        let sum = 0;
        for (let i=0;i<data.length;i++) sum += data[i];
        const avg = sum / data.length;

        const now = Date.now();
        if (avg > TH){
          lastOn = now;
          if (!speaking){
            speaking = true;
            targetEl.classList.add("is-speaking");
          }
        } else {
          if (speaking && (now - lastOn) > HOLD_MS){
            speaking = false;
            targetEl.classList.remove("is-speaking");
          }
        }
        raf = requestAnimationFrame(loop);
      };
      raf = requestAnimationFrame(loop);
    }

    function stop(){
      try{ if (raf) cancelAnimationFrame(raf); }catch{}
      raf = 0;
      try{ targetEl.classList.remove("is-speaking"); }catch{}
      speaking = false;
      try{ if (src) src.disconnect(); }catch{}
      src = null;
      try{ if (ctx) ctx.close(); }catch{}
      ctx = null;
      analyser = null;
      data = null;
    }

    // restart when stream changes
    const _set = ()=>{
      stop();
      start();
    };

    // run now + also after play
    _set();
    videoEl.addEventListener("loadedmetadata", _set);
    videoEl.addEventListener("play", _set);

    // expose for manual cleanup
    videoEl.__stopSpeakingIndicator = stop;
  }catch(e){
    console.warn("attachSpeakingIndicator error:", e);
  }
}
// ===== /AUTO SPEAKING HIGHLIGHT =====

// ===== AUTO MINI PLAYER WHEN TAB BACKGROUND (MOBILE) =====
let __wasAutoMini = false;

function enableAutoMini(){
  if (!document.body.classList.contains("auto-mini")){
    document.body.classList.add("auto-mini");
    __wasAutoMini = true;
  }
}

function disableAutoMini(){
  if (__wasAutoMini){
    document.body.classList.remove("auto-mini");
    __wasAutoMini = false;
  }
}

// Khi chuyá»ƒn tab / app
document.addEventListener("visibilitychange", ()=>{
  if (document.hidden){
    enableAutoMini();
  } else {
    disableAutoMini();
  }
});

// iOS Safari Ä‘áº·c biá»‡t hay dÃ¹ng pagehide/pageshow
window.addEventListener("pagehide", enableAutoMini);
window.addEventListener("pageshow", disableAutoMini);



// ===== PIN NOTE (display only) =====
const pinOverlay = document.getElementById("pinOverlay");
function __clamp01(n){ n = Number(n); if (!isFinite(n)) return 0.5; return Math.max(0, Math.min(1, n)); }
function renderPin(note){
  if (!pinOverlay) return;
  pinOverlay.innerHTML = "";
  if (!note) return;
  const wrap = document.createElement("div");
  wrap.className = "pin-note";
  wrap.style.left = (__clamp01(note.x) * 100).toFixed(3) + "%";
  wrap.style.top  = (__clamp01(note.y) * 100).toFixed(3) + "%";

  const head = document.createElement("div");
  head.className = "pin-head";
  const title = document.createElement("div");
  title.className = "pin-title";
  title.innerHTML = ``;
  head.appendChild(title);

  const body = document.createElement("div");
  body.className = "pin-body";
  body.textContent = String(note.text || "");

  wrap.appendChild(head);
  wrap.appendChild(body);
  pinOverlay.appendChild(wrap);
}
socket.on("pin-note-update", (note)=> renderPin(note));
// ===== /PIN NOTE =====

// ===== LIVE TIMER (HH:MM:SS) =====
let __liveStartTs = null;
let __liveTick = null;

function __pad2(n){ n = Math.floor(Math.max(0, n)); return String(n).padStart(2,"0"); }
function __fmtHMS(ms){
  const s = Math.floor(ms/1000);
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${__pad2(hh)}:${__pad2(mm)}:${__pad2(ss)}`;
}
function __setTimerText(el, ms){
  if (!el) return;
  el.textContent = `â± ${__fmtHMS(ms)}`;
}
function __startTimer(el, startTs){
  __liveStartTs = startTs;
  if (__liveTick) clearInterval(__liveTick);
  __setTimerText(el, Date.now() - __liveStartTs);
  __liveTick = setInterval(()=>__setTimerText(el, Date.now() - __liveStartTs), 250);
}
function __stopTimer(el){
  __liveStartTs = null;
  if (__liveTick) clearInterval(__liveTick);
  __liveTick = null;
  if (el) el.textContent = "â± 00:00:00";
}

const liveTimerViewer = document.getElementById("liveTimerViewer");
socket.on("live-start", ({ startTs }) => {

  document.body.classList.add("is-live");

  if (typeof startTs === "number") __startTimer(liveTimerViewer, startTs);
});
socket.on("live-stop", () => {
  __stopTimer(liveTimerViewer);
});


// ===== REACTIONS (tap/click to heart) =====
function clamp01(n){ return Math.max(0, Math.min(1, n)); }
function now(){ return Date.now(); }

function attachTapToHeart(tapEl, layerEl, getRoomIdFn) {
  if (!tapEl || !layerEl) return;
  let last = 0;
  const MIN_MS = 180; // anti-spam client side

  const handler = (ev) => {
    // prevent video click from toggling play/pause
    try { if (ev && ev.cancelable) ev.preventDefault(); } catch {}
    try { ev.stopPropagation(); } catch {}
    // ignore clicks on controls/buttons/inputs
    const t = ev.target;
    if (t && (t.closest("button") || t.closest("input") || t.closest("textarea"))) return;

    const ts = now();
    if (ts - last < MIN_MS) return;
    last = ts;

    const rect = tapEl.getBoundingClientRect();
    const cx = ("clientX" in ev) ? ev.clientX : (ev.touches && ev.touches[0] ? ev.touches[0].clientX : rect.left + rect.width/2);
    const cy = ("clientY" in ev) ? ev.clientY : (ev.touches && ev.touches[0] ? ev.touches[0].clientY : rect.top + rect.height/2);
    const x = clamp01((cx - rect.left) / rect.width);
    const y = clamp01((cy - rect.top) / rect.height);

    const msg = { roomId: getRoomIdFn(), emoji: "â¤ï¸", x, y };
    // show immediately on self
    spawnReaction(layerEl, msg.emoji, msg.x, msg.y, true);
    socket.emit("reaction", msg);
  };

  tapEl.addEventListener("pointerdown", handler, { passive: false });
  // also fallback for old browsers
  tapEl.addEventListener("click", handler);
}

function spawnReaction(layerEl, emoji, x, y, local=false) {
  if (!layerEl) return;
  const el = document.createElement("div");
  el.className = "reaction-float";
  el.textContent = emoji || "â¤ï¸";
  // random motion
  const dx = (Math.random() * 120 - 60).toFixed(1); // px
  const rot = (Math.random() * 30 - 15).toFixed(1); // deg
  const sc = (0.85 + Math.random() * 0.8).toFixed(2);
  el.style.setProperty("--x", String(x));
  el.style.setProperty("--y", String(y));
  el.style.setProperty("--dx", dx + "px");
  el.style.setProperty("--rot", rot + "deg");
  el.style.setProperty("--sc", sc);
  if (local) el.classList.add("is-local");
  layerEl.appendChild(el);
  setTimeout(()=>{ try{ el.remove(); }catch{} }, 1800);
}

socket.on("reaction", (msg)=>{
  try {
    if (!msg) return;
    const emoji = msg.emoji || "â¤ï¸";
    const x = clamp01(Number(msg.x ?? 0.5));
    const y = clamp01(Number(msg.y ?? 0.7));
    // choose layer based on whether it's guest/host layer (we only have one layer per page for now)
    const layer = document.getElementById("reactionsLayerViewer");
    spawnReaction(layer, emoji, x, y, false);
  } catch (e) {
    console.warn("reaction render error", e);
  }
});

// ===== INIT TAP-TO-HEART on main live card =====
(function initTapHearts(){
  const __tapEl = document.getElementById("hostCard");
  const __layerEl = document.getElementById("reactionsLayerViewer");
  if (!__tapEl || !__layerEl) return;
  attachTapToHeart(__tapEl, __layerEl, ()=>roomId);
})();


    let joined = false;
    let __viewerNeedResume = false;


// ================== ANTI LAG PRO ==================
function applyBitrateGuard(pc, profile = "MEDIUM") {
  const VIDEO_PROFILES = {
    LOW:    { max: 350_000,  min: 150_000 },
    MEDIUM: { max: 800_000,  min: 300_000 },
    HIGH:   { max: 1_500_000, min: 600_000 },
  };

  const cfg = VIDEO_PROFILES[profile] || VIDEO_PROFILES.MEDIUM;

  pc.getSenders().forEach(sender => {
    if (!sender.track) return;

    const params = sender.getParameters();
    if (!params.encodings) params.encodings = [{}];

    if (sender.track.kind === "video") {
      params.encodings[0].maxBitrate = cfg.max;
      params.encodings[0].minBitrate = cfg.min;
      params.encodings[0].priority = "medium";
      params.encodings[0].networkPriority = "high";
    }

    if (sender.track.kind === "audio") {
      params.encodings[0].priority = "high";
      params.encodings[0].networkPriority = "high";
      params.encodings[0].maxBitrate = 96_000;
    }

    sender.setParameters(params).catch(()=>{});
  });
}

function enableAdaptiveQuality(pc, videoTrack) {
  setInterval(async () => {
    if (!pc || !videoTrack) return;

    const stats = await pc.getStats();
    let loss = 0, rtt = 0;

    stats.forEach(r => {
      if (r.type === "outbound-rtp" && r.kind === "video") {
        loss = r.packetsLost || 0;
      }
      if (r.type === "candidate-pair" && r.currentRoundTripTime) {
        rtt = r.currentRoundTripTime;
      }
    });

    // máº¡ng yáº¿u
    if (loss > 20 || rtt > 0.4) {
      videoTrack.applyConstraints({
        width: 640,
        height: 360,
        frameRate: 20
      }).catch(()=>{});
    }

    // máº¡ng tá»‘t
    if (loss === 0 && rtt < 0.2) {
      videoTrack.applyConstraints({
        width: 1280,
        height: 720,
        frameRate: 30
      }).catch(()=>{});
    }
  }, 4000);
}

function detectViewerProfile() {
  const isMobile = /Android|iPhone/i.test(navigator.userAgent);
  const lowCPU = navigator.hardwareConcurrency <= 4;
  return (isMobile || lowCPU) ? "LOW" : "MEDIUM";
}
// ================== /ANTI LAG PRO ==================



// ================= AUDIO ONLY FALLBACK =================
function enableAudioOnlyFallback(pc, videoTrack, label = "") {
  let audioOnly = false;
  let lastSwitch = 0;

  setInterval(async () => {
    if (!pc || !videoTrack) return;

    const stats = await pc.getStats();
    let loss = 0, rtt = 0;

    stats.forEach(r => {
      if (r.type === "outbound-rtp" && r.kind === "video") {
        loss = r.packetsLost || 0;
      }
      if (r.type === "candidate-pair" && r.currentRoundTripTime) {
        rtt = r.currentRoundTripTime;
      }
    });

    const now = Date.now();
    if (now - lastSwitch < 5000) return; // trÃ¡nh báº­t táº¯t liÃªn tá»¥c

    // ğŸš¨ Máº NG Ráº¤T Yáº¾U â†’ AUDIO ONLY
    if (!audioOnly && (loss > 50 || rtt > 0.8)) {
      console.warn("ğŸ§ AUDIO ONLY ON", label);
      videoTrack.enabled = false;
      audioOnly = true;
      lastSwitch = now;

      document.body.classList.add("audio-only");
    }

    // âœ… Máº NG á»”N Láº I â†’ Báº¬T VIDEO
    if (audioOnly && loss < 10 && rtt < 0.3) {
      console.warn("ğŸ¥ VIDEO RESUME", label);
      videoTrack.enabled = true;
      audioOnly = false;
      lastSwitch = now;

      document.body.classList.remove("audio-only");
    }
  }, 3000);
}
// ================= /AUDIO ONLY FALLBACK =================



    // multiple peer connections: broadcaster + guest
    const pcs = new Map(); // peerId -> RTCPeerConnection
    let guestId = null;

    async function getRtcConfig() {
      const fallback = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

      try {
        const r = await fetch("/ice", { cache: "no-store" });
        if (!r.ok) return fallback;

        const data = await r.json();
        if (!data.iceServers || !Array.isArray(data.iceServers)) return fallback;

        // Remove invalid STUN urls that contain ?transport=
        const cleanedIceServers = data.iceServers
          .map(server => {
            let urls = server.urls;
            if (!urls) return null;
            if (!Array.isArray(urls)) urls = [urls];

            const safeUrls = urls.filter(u =>
              typeof u === "string" &&
              !(u.startsWith("stun:") && u.includes("?transport="))
            );
            if (safeUrls.length === 0) return null;
            return { ...server, urls: safeUrls };
          })
          .filter(Boolean);

        if (cleanedIceServers.length === 0) return fallback;
        return { iceServers: cleanedIceServers };
      } catch (e) {
        console.error("ICE fetch error:", e);
        return fallback;
      }
    }

    function log(msg) {
      logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
      console.log(msg);
    }

    const liveStatusText = document.getElementById("liveStatusText");
    function setStatus(text) {
      badge.textContent = text;
      if (liveStatusText) liveStatusText.textContent = text.replace(/^[^ ]+\s*/, "");
    }

    socket.on("broadcaster-online", () => setStatus("âœ… Host online"));
    socket.on("broadcaster-offline", () => setStatus("â›” Host offline"));
    socket.on("broadcaster-changed", () => {
      setStatus("ğŸ”„ Host changed â€“ hÃ£y báº¥m Join láº¡i");
      cleanupAll();
    });

    // guest events
    socket.on("guest-online", ({ guestId: gid }) => {

      document.body.classList.add("has-guest");
if (guestPipWrap) guestPipWrap.setAttribute("aria-hidden", "false");

      guestId = gid;
      log("Guest online: " + gid);
      setStatus("ğŸŸ¢ CÃ³ Guest cÃ¹ng live");
      // request guest to stream to this viewer
      socket.emit("watch-guest", { roomId });
    });


    socket.on("guest-offline", () => {
clearGuestView("server-event");
      document.body.classList.remove("has-guest");
document.body.classList.remove("swap-live");
swapped = false;
if (guestPipWrap) guestPipWrap.setAttribute("aria-hidden", "true");

      log("Guest offline");
      guestId = null;
      guestPlayer.srcObject = null;
      // close guest pc if exists
      cleanupPeer("guest");
    });




    async function join() {
      if (joined) return;
      joined = true;
      
      try{ btnJoin.style.display = "none"; }catch{}
socket.emit("join-room", { roomId, role: "viewer", profile: { name: (chatName.value||"Viewer").trim().slice(0,20), coins: Number(localStorage.getItem("ls_coins")||0) || 0 } });
      setStatus("â³ Äang chá» Host gá»­i LIVE...");
      log("ÄÃ£ join room, Ä‘á»£i offer tá»« host/guest...");
    }

    function cleanupPeer(peerKey) {
      // peerKey can be actual peerId or "guest"
      if (peerKey === "guest") {
        // find by guestId if present
        if (guestId && pcs.has(guestId)) {
          try { pcs.get(guestId).close(); } catch {}
          pcs.delete(guestId);
        }
        return;
      }
      const pc = pcs.get(peerKey);
      if (pc) {
        try { pc.close(); } catch {}
        pcs.delete(peerKey);
      }
    }

    function cleanupAll() {
      for (const pc of pcs.values()) {
        try { pc.close(); } catch {}
      }
      pcs.clear();
      player.srcObject = null;
      guestPlayer.srcObject = null;
      joined = false;
    }


    function forcePlayVideo(video) {
  if (!video) return;

  video.muted = true;        // Báº®T BUá»˜C
  video.playsInline = true;

  const tryPlay = () => {
    const p = video.play();
    if (p && typeof p.catch === "function") {
      p.catch(() => {
        // retry sau 300ms
        setTimeout(tryPlay, 300);
      });
    }
  };

  // gá»i nhiá»u láº§n cho cháº¯c
  tryPlay();
  setTimeout(tryPlay, 500);
  setTimeout(tryPlay, 1000);
}


    // Receive offer from broadcaster OR guest
    socket.on("offer", async ({ from, description }) => {

      /*
      // reset pc for this peer only
      cleanupPeer(from);
      */
     
      const rtcConfig = await getRtcConfig();
      const pc = new RTCPeerConnection(rtcConfig);
      pcs.set(from, pc);

      // ğŸš€ ANTI LAG â€“ VIEWER
const profile = detectViewerProfile();
applyBitrateGuard(pc, profile);

     
  // Auto ask peer to ICE-restart if connection degrades
  pc.onconnectionstatechange = () => {
    const st = pc.connectionState;
    if (st === 'failed' || st === 'disconnected'){
      try{ socket.emit('request-ice-restart', { to: from, reason: 'viewer_pc_' + st }); }catch{}
    }
  };


pc.ontrack = (event) => {
  const stream = event.streams[0];
  if (!stream) return;

  // ğŸ”‘ PHÃ‚N BIá»†T DUY NHáº¤T Báº°NG peerId
  if (guestId && from === guestId) {
    // ===== GUEST STREAM =====
    console.log("ğŸ¥ Viewer nháº­n stream GUEST");

    guestPipWrap.style.display = "block";
    guestPipWrap.setAttribute("aria-hidden", "false");

    if (guestPlayer.srcObject !== stream) {
      guestPlayer.srcObject = stream;
      guestPlayer.muted = false;
      guestPlayer.playsInline = true;
      guestPlayer.play().catch(() => {});
    }

    try {
      attachSpeakingIndicator(
        guestPlayer,
        document.getElementById("guestPipWrap")
      );
    } catch {}

  } else {
    // ===== HOST STREAM (CHÃNH) =====
    console.log("ğŸ¥ Viewer nháº­n stream HOST");

    if (player.srcObject !== stream) {
      player.srcObject = stream;


      // ğŸ§ AUDIO ONLY â€“ VIEWER (decode lag)
let __viewerAudioOnly = false;

setInterval(() => {
  if (!player || !player.srcObject) return;

  const v = player;
  const frozen = v.readyState < 2 || v.videoWidth === 0;

  if (frozen && !__viewerAudioOnly) {
    console.warn("ğŸ§ Viewer audio only");
    v.style.display = "none";
    __viewerAudioOnly = true;
    document.body.classList.add("audio-only");
  }

  if (!frozen && __viewerAudioOnly) {
    console.warn("ğŸ¥ Viewer video resume");
    v.style.display = "";
    __viewerAudioOnly = false;
    document.body.classList.remove("audio-only");
  }
}, 2000);



      player.muted = true;          // autoplay mobile
      player.playsInline = true;
      player.play().catch(() => {});
    }

    const hasAudio = stream.getAudioTracks().length > 0;

if (hasAudio) {
  player.muted = false;
  player.volume = 1.0;

  const tryPlay = async () => {
    try { await player.play(); } catch {}
  };

  if (player.paused) tryPlay();
}

    try {
      attachSpeakingIndicator(
        player,
        document.getElementById("hostCard")
      );
    } catch {}
  }

  setStatus("ğŸŸ¢ Äang xem LIVE");
};






      pc.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit("candidate", { to: from, candidate: e.candidate });
        }
      };

      pc.oniceconnectionstatechange = () => {
        log(`ICE(${from}): ${pc.iceConnectionState}`);

const st = pc.iceConnectionState;
  if (st === "failed" || st === "disconnected") {
    socket.emit("request-ice-restart", {
      to: hostId,
      reason: "viewer_resume"
    });
  }

      };

      try {
        await pc.setRemoteDescription(description);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.emit("answer", { to: from, description: pc.localDescription });

    if (resume) {
      log("ğŸ”„ Viewer resumed WebRTC");
    } else {
      log("ğŸ¥ Viewer nháº­n stream má»›i");
    }

        setStatus("ğŸŸ¢ Äang xem live trá»±c tiáº¿p.");
        log("ÄÃ£ gá»­i answer cho: " + from);
      } catch (err) {
        log("Lá»—i xá»­ lÃ½ offer: " + err.message);
      }
    });

    socket.on("candidate", async ({ from, candidate }) => {
      const pc = pcs.get(from);
      if (!pc) return;
      try {
        await pc.addIceCandidate(candidate);
      } catch (err) {
        log("Lá»—i addIceCandidate: " + err.message);
      }
    });

    btnJoin.onclick = () => {
      join().catch(err => log("Join lá»—i: " + err.message));
    };

    // âœ… Auto-join on load (viewer sáº½ tá»± tham gia xem, khÃ´ng cáº§n báº¥m nÃºt)
    (function autoJoinViewer(){
      try {
        btnJoin.disabled = true;
        btnJoin.textContent = "â³ Äang tham gia...";
        // delay nháº¹ Ä‘á»ƒ Ä‘áº£m báº£o socket vÃ  UI Ä‘Ã£ sáºµn sÃ ng
        setTimeout(() => {
          join().catch(err => {
            // náº¿u lá»—i, má»Ÿ láº¡i nÃºt cho user báº¥m thá»­
            btnJoin.disabled = false;
            btnJoin.textContent = "Tham gia xem Livestream";
            log("Auto-join lá»—i: " + (err?.message || err));
          });
        }, 120);
      } catch {}
    })();




// ===== REQUEST TO GO LIVE (VIEWER -> GUEST) =====
const btnRequestLive = document.getElementById("btnRequestLive");

// máº·c Ä‘á»‹nh disable khi host chÆ°a online
btnRequestLive.disabled = true;

btnRequestLive.onclick = () => {
  const url = `/guest.html?room=${encodeURIComponent(roomId)}`;
  // má»Ÿ tab má»›i Ä‘á»ƒ váº«n xem Ä‘Æ°á»£c live
  window.open(url, "_blank");
};

// chá»‰ cho xin lÃªn live khi broadcaster online
socket.on("broadcaster-online", () => {
  btnRequestLive.disabled = false;
});

socket.on("broadcaster-offline", () => {
  btnRequestLive.disabled = true;
});



    // ===== CHAT (VIEWER) =====
    const chatBox = document.getElementById("chatBox");
    const chatName = document.getElementById("chatName");
    const chatText = document.getElementById("chatText");
    const chatSend = document.getElementById("chatSend");

    function addChat(msg) {
      const time = new Date(msg.ts).toLocaleTimeString();
      const role = String(msg.role || "viewer");
      const tag = role === "host" ? "[HOST]" : role === "guest" ? "[GUEST]" : "";
      const line = document.createElement("div");
      line.className = "chat-line chat-" + role;
      line.textContent = `[${time}] ${tag ? tag + " " : ""}${msg.name}: ${msg.text}`;
      chatBox.appendChild(line);
      chatBox.scrollTop = chatBox.scrollHeight;
    }
 
    socket.on("chat", (msg)=>{ addChat(msg); pushOverlay(msg); });

    // ===== CHAT OVERLAY + EMOJI QUICK BAR ===== // CHAT OVERLAY
    const chatOverlay = document.getElementById("chatOverlay");
    function pushOverlay(msg){
      if (!chatOverlay) return;
      const role = String(msg.role || "viewer");
      const tag = role === "host" ? "[HOST]" : role === "guest" ? "[GUEST]" : "";
      const el = document.createElement("div");
      el.className = "chat-bubble chat-" + role;
      el.textContent = `${tag ? tag + " " : ""}${msg.name}: ${msg.text}`;
      chatOverlay.appendChild(el);

      // keep only last 4 bubbles
      while (chatOverlay.children.length > 4) chatOverlay.removeChild(chatOverlay.firstChild);

      // auto fade + remove
      setTimeout(() => el.classList.add("hide"), 2600);
      setTimeout(() => { try { el.remove(); } catch {} }, 3200);
    }

    // add emoji buttons
    const emojiBar = document.getElementById("emojiBar");
    if (emojiBar) {
      emojiBar.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-emoji]");
        if (!btn) return;
        const em = btn.getAttribute("data-emoji") || "";
        chatText.value = (chatText.value || "") + em;
        chatText.focus();
      });
    }


    chatSend.onclick = () => {
      const name = (chatName.value || "Viewer").trim();
      const text = chatText.value.trim();
      if (!text) return;

      socket.emit("chat", { roomId, name, text, role: "viewer" });
      chatText.value = "";
    };

    const viewerCountViewer = document.getElementById("viewerCountViewer");


const joinOverlayViewer = document.getElementById("joinOverlayViewer");
function pushJoinViewer(text){
  if (!joinOverlayViewer) return;
  const el = document.createElement("div");
  el.className = "join-bubble";
  el.textContent = text;
  joinOverlayViewer.appendChild(el);
  while (joinOverlayViewer.children.length > 3) joinOverlayViewer.removeChild(joinOverlayViewer.firstChild);
  setTimeout(()=>el.classList.add("hide"), 1400);
  setTimeout(()=>{ try{el.remove();}catch{} }, 2000);
}
socket.on("viewer-join", ({ id }) => {
  pushJoinViewer("â• CÃ³ ngÆ°á»i vÃ o xem");
});
socket.on("viewer-leave", ({ id }) => {
  pushJoinViewer("â– CÃ³ ngÆ°á»i rá»i");
});

socket.on("viewer-count", ({ count }) => {
  if (viewerCountViewer) {
    viewerCountViewer.textContent = `ğŸ‘: ${count}`;
  
    try { viewerCountViewer.classList.remove("pulse"); void viewerCountViewer.offsetWidth; viewerCountViewer.classList.add("pulse"); } catch {}}
});


function swapStreams(){
  const hostStream = player.srcObject;
  const guestStream = guestPlayer.srcObject;
  if (!hostStream || !guestStream) return;

  // Ä‘á»•i stream
  player.srcObject = guestStream;
  guestPlayer.srcObject = hostStream;

  swapped = !swapped;
  document.body.classList.toggle("swap-live", swapped);
}

if (guestPipWrap) {
  guestPipWrap.addEventListener("click", () => {
    swapStreams();
  });
}

// ===== GIFT ENGINE (client) =====
const GIFT_CLIENT_CATALOG = {
  heart:  { emoji:"â¤ï¸", cost:5,  title:"Tim" },
  flower: { emoji:"ğŸŒ¸", cost:5,  title:"Hoa" },
  rocket: { emoji:"ğŸš€", cost:5, title:"Rocket" },
  coin:   { emoji:"ğŸ’°", cost:5, title:"TÃºi tiá»n" },
  dragon: { emoji:"ğŸ‰", cost:5, title:"Rá»“ng" },
  phoenix:{ emoji:"ğŸ¦…", cost:5, title:"PhÆ°á»£ng hoÃ ng" },
  galaxy: { emoji:"ğŸŒŒ", cost:5, title:"Dáº£i ngÃ¢n hÃ " },
  meteor: { emoji:"â˜„ï¸", cost:5, title:"Sao bÄƒng" },
  king:   { emoji:"ğŸ‘‘", cost:5, title:"VÆ°Æ¡ng miá»‡n" },
  dragonking: { emoji:"ğŸ²", cost:5, title:"Dragon King" },
  supernova:  { emoji:"ğŸŒ ", cost:5, title:"Supernova" },
};

// ===== COIN ERROR MODAL =====
const cem = document.getElementById("coinErrorModal");
const cemWallet = document.getElementById("cemWallet");
const cemClose = document.getElementById("cemClose");
const cemOk = document.getElementById("cemOk");

function openCoinErrorModal(){
  cemWallet.textContent = walletCoins?.textContent || "0";
  cem.classList.remove("hidden");
  cem.setAttribute("aria-hidden","false");
}

function closeCoinErrorModal(){
  cem.classList.add("hidden");
  cem.setAttribute("aria-hidden","true");
}

cemClose?.addEventListener("click", closeCoinErrorModal);
cemOk?.addEventListener("click", closeCoinErrorModal);
cem?.querySelector(".cem-bg")?.addEventListener("click", closeCoinErrorModal);


// ===== GIFT CONFIRM LOGIC =====
const gcm = document.getElementById("giftConfirmModal");
const gcmEmoji = document.getElementById("gcmEmoji");
const gcmTitle = document.getElementById("gcmTitle");
const gcmCost = document.getElementById("gcmCost");
const gcmQty = document.getElementById("gcmQty");
const gcmTotal = document.getElementById("gcmTotal");
const gcmWallet = document.getElementById("gcmWallet");
const gcmOk = document.getElementById("gcmOk");
const gcmCancel = document.getElementById("gcmCancel");
const gcmClose = document.getElementById("gcmClose");

let __pendingGift = null;

function openGiftConfirm(data){
  __pendingGift = data;
  gcmEmoji.textContent = data.emoji;
  gcmTitle.textContent = data.title;
  gcmCost.textContent = data.cost;
  gcmQty.textContent = "x" + data.qty;
  gcmTotal.textContent = (data.cost * data.qty) + " coin";
  gcmWallet.textContent = walletCoins.textContent || "0";

  gcm.classList.remove("hidden");
  gcm.setAttribute("aria-hidden","false");
}

function closeGiftConfirm(){
  gcm.classList.add("hidden");
  gcm.setAttribute("aria-hidden","true");
  __pendingGift = null;
}

gcmCancel?.addEventListener("click", closeGiftConfirm);
gcmClose?.addEventListener("click", closeGiftConfirm);
gcm?.querySelector(".gcm__bg")?.addEventListener("click", closeGiftConfirm);

// CONFIRM SEND
gcmOk.addEventListener("click", ()=>{
  if (!__pendingGift) return;

  const wallet = Number(walletCoins.textContent || 0);
  const total = __pendingGift.cost * __pendingGift.qty;

  // âŒ KHÃ”NG Äá»¦ COIN â†’ Má» MODAL Lá»–I
  if (wallet < total){
    closeGiftConfirm();
    openCoinErrorModal();
    return;
  }

  // âœ… Äá»¦ COIN â†’ Gá»¬I
  socket.emit("send-gift", {
    roomId,
    name: (chatName?.value || "Viewer").slice(0,20),
    gift: {
      type: __pendingGift.type,
      qty: __pendingGift.qty
    }
  });

  closeGiftConfirm();
});


// OVERRIDE click quÃ 
document.querySelectorAll(".gift-panel__grid button").forEach(btn=>{
  btn.onclick = ()=>{
    const type = btn.dataset.gift;
    const catalog = {
      heart:{emoji:"â¤ï¸",cost:1,title:"Tim"},
      flower:{emoji:"ğŸŒ¸",cost:5,title:"Hoa"},
      rocket:{emoji:"ğŸš€",cost:20,title:"Rocket"},
      coin:{emoji:"ğŸ’°",cost:50,title:"TÃºi tiá»n"},
      dragon:{emoji:"ğŸ‰",cost:120,title:"Rá»“ng"},
      phoenix:{emoji:"ğŸ¦…",cost:200,title:"PhÆ°á»£ng hoÃ ng"},
      galaxy:{emoji:"ğŸŒŒ",cost:300,title:"Dáº£i ngÃ¢n hÃ "},
      meteor:{emoji:"â˜„ï¸",cost:500,title:"Sao bÄƒng"},
      king:{emoji:"ğŸ‘‘",cost:800,title:"VÆ°Æ¡ng miá»‡n"},
      dragonking:{emoji:"ğŸ²",cost:1500,title:"Dragon King"},
      supernova:{emoji:"ğŸŒ ",cost:2200,title:"Supernova"},
    }[type];
    if (!catalog) return;

    openGiftConfirm({
      type,
      ...catalog,
      qty: __giftCombo || 1
    });
  };
});



// âœ… Combo multiplier (x1/x5/x10)
let __giftCombo = 1;
try {
  const saved = Number(localStorage.getItem("ls_gift_combo") || 1);
  if (Number.isFinite(saved) && saved >= 1) __giftCombo = saved;
} catch {}

const __comboWrap = document.getElementById("giftCombo");
if (__comboWrap) {
  const __btns = __comboWrap.querySelectorAll(".gift-combo__btn");
  // init active by saved value
  __btns.forEach(b => {
    const v = Number(b.dataset.combo || 1) || 1;
    b.classList.toggle("is-active", v === __giftCombo);
  });

  __comboWrap.addEventListener("click", (ev) => {
    const btn = ev.target && ev.target.closest(".gift-combo__btn");
    if (!btn) return;
    const v = Number(btn.dataset.combo || 1) || 1;
    __giftCombo = Math.max(1, Math.min(999, v));
    try { localStorage.setItem("ls_gift_combo", String(__giftCombo)); } catch {}
    __btns.forEach(b => b.classList.toggle("is-active", b === btn));

    // feedback
    try {
      const t = document.createElement("div");
      t.className = "gift-toast";
      t.textContent = `âœ… ÄÃ£ chá»n combo x${__giftCombo}`;
      document.body.appendChild(t);
      setTimeout(()=>t.classList.add("hide"), 900);
      setTimeout(()=>{ try{t.remove();}catch{} }, 1400);
    } catch {}
  });
}

// Send gift with selected combo qty
document.querySelectorAll(".gift-bar button").forEach(btn => {
  btn.onclick = () => {
    const type = btn.dataset.gift;
    const name = (chatName.value || "Viewer").trim().slice(0,20);
    const qty = Math.max(1, Math.min(999, Number(__giftCombo || 1) || 1));
    socket.emit("send-gift", { roomId, name, gift: { type, qty } });
  };
});
// ===== /GIFT ENGINE (client) =====
const giftLayer = document.getElementById("giftLayer");

function spawnBigGiftSfx(mode){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();

    // layered chord for VIP
    const isVip = (mode==="dragonking" || mode==="supernova");
    const o1 = ctx.createOscillator();
    const o2 = ctx.createOscillator();
    const g  = ctx.createGain();

    o1.type = "sine";
    o2.type = isVip ? "triangle" : "sine";

    const now = ctx.currentTime;
    const base = mode==="supernova" ? 196 : mode==="dragonking" ? 220
               : mode==="king" ? 330
               : mode==="meteor" ? 246
               : mode==="galaxy" ? 260
               : 300;

    // chord interval
    const interval = isVip ? 1.4983 : 1.2599; // perfect fifth / major third

    o1.frequency.setValueAtTime(base, now);
    o2.frequency.setValueAtTime(base*interval, now);

    // little rise
    o1.frequency.exponentialRampToValueAtTime(base*2.2, now+0.20);
    o2.frequency.exponentialRampToValueAtTime(base*interval*2.0, now+0.20);

    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(isVip ? 0.24 : 0.18, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + (isVip ? 0.34 : 0.22));

    o1.connect(g); o2.connect(g); g.connect(ctx.destination);
    o1.start(now); o2.start(now);
    o1.stop(now + (isVip ? 0.36 : 0.24));
    o2.stop(now + (isVip ? 0.36 : 0.24));

    setTimeout(()=>{ try{ctx.close();}catch{} }, 600);
  }
  catch{}
}

function spawnGiftParticles(mode){
  try{
    const wrap = document.createElement("div");
    wrap.className = "gift-particles gift-particles--" + (mode||"");
    document.body.appendChild(wrap);
    const n = mode==="meteor" ? 26 : mode==="king" ? 32 : 18;
    for (let i=0;i<n;i++){
      const p = document.createElement("div");
      p.className = "gift-p";
      p.style.left = (Math.random()*100)+"%";
      p.style.top  = (Math.random()*100)+"%";
      p.style.setProperty("--dx", (Math.random()*220-110)+"px");
      p.style.setProperty("--dy", (Math.random()*220-140)+"px");
      p.style.setProperty("--rot", (Math.random()*120-60)+"deg");
      p.style.setProperty("--sc", (Math.random()*0.7+0.6));
      wrap.appendChild(p);
    }
    setTimeout(()=>{ try{wrap.remove();}catch{} }, 2200);
  }catch{}
}

function spawnBigGift(emoji, mode, donor, giftMeta){
  const big = document.createElement("div");
  big.className = "gift-big " + (mode ? ("gift-big--"+mode) : "");
  big.innerHTML = `
    <div class="gift-big__bg"></div>
    <div class="gift-big__emoji">${emoji}</div>
    <div class="gift-big__spark"></div>
    <div class="gift-big__fx"></div>
    <div class="gift-big__banner" id="giftBanner">
      <div class="gift-big__title" id="giftTitle"></div>
      <div class="gift-big__sub" id="giftSub"></div>
      <div class="gift-big__cd"><span class="gift-big__cdbar"></span></div>
    </div>
  `;
  document.body.appendChild(big);
  spawnBigGiftSfx(mode);
  spawnGiftParticles(mode);

  // banner text + duration
  try{
    const dn = (donor || "Ai Ä‘Ã³").toString().slice(0, 20);
    const qty = Number(giftMeta?.qty || 1) || 1;
    const coins = Number(giftMeta?.coins || 0) || 0;
    const title = (mode === "dragonking") ? "ğŸ² DRAGON KING" :
                  (mode === "supernova") ? "ğŸŒ  SUPERNOVA" :
                  (mode === "king") ? "ğŸ‘‘ KING" :
                  (mode === "meteor") ? "â˜„ï¸ METEOR" :
                  (mode === "galaxy") ? "ğŸŒŒ GALAXY" :
                  (mode === "phoenix") ? "ğŸ¦… PHOENIX" :
                  (mode === "dragon") ? "ğŸ‰ DRAGON" :
                  (mode === "rocket") ? "ğŸš€ ROCKET" : "ğŸ GIFT";
    const sub = `${dn} â€¢ x${qty} â€¢ +${coins} coin`;
    big.querySelector("#giftTitle")?.replaceChildren(document.createTextNode(title));
    big.querySelector("#giftSub")?.replaceChildren(document.createTextNode(sub));
  }catch{}

  const __dur = (mode==="dragonking" || mode==="supernova") ? 3000 : 2200;
if (mode==="meteor" || mode==="king") document.body.classList.add("gift-shake");
  setTimeout(()=>{ try{document.body.classList.remove("gift-shake");}catch{} }, 520);
setTimeout(()=>big.classList.add("hide"), Math.max(1400, __dur - 800));
  setTimeout(()=>{ try{big.remove();}catch{} }, __dur);
}

function spawnGift(type, donor, giftMeta){
  const el = document.createElement("div");
  el.className = "gift-item gift-item--" + type;

  const emoji =
    type === "heart"  ? "â¤ï¸" :
    type === "flower" ? "ğŸŒ¸" :
    type === "rocket" ? "ğŸš€" :
    type === "dragon" ? "ğŸ‰" :
    type === "phoenix"? "ğŸ¦…" :
    type === "galaxy" ? "ğŸŒŒ" :
    type === "meteor" ? "â˜„ï¸" :
    type === "king"   ? "ğŸ‘‘" :
    type === "dragonking" ? "ğŸ²" :
    type === "supernova"  ? "ğŸŒ " :
    "ğŸ’°";

  el.textContent = emoji;
  el.style.left = Math.random()*80 + 10 + "%";
  el.style.bottom = "10%";

  giftLayer.appendChild(el);
  setTimeout(()=>el.remove(), 2000);

  if (type === "rocket") spawnBigGift("ğŸš€", "rocket", donor, giftMeta);
  if (type === "dragon") spawnBigGift("ğŸ‰", "dragon", donor, giftMeta);
  if (type === "phoenix") spawnBigGift("ğŸ¦…", "phoenix", donor, giftMeta);
  if (type === "galaxy") spawnBigGift("ğŸŒŒ", "galaxy", donor, giftMeta);
  if (type === "meteor") spawnBigGift("â˜„ï¸", "meteor", donor, giftMeta);
  if (type === "king") spawnBigGift("ğŸ‘‘", "king", donor, giftMeta);
  if (type === "dragonking") spawnBigGift("ğŸ²", "dragonking", donor, giftMeta);
  if (type === "supernova") spawnBigGift("ğŸŒ ", "supernova", donor, giftMeta);
}
socket.on("gift", ({ gift, donor })=>{
  // spawn animation
  spawnGift(gift.type, donor, gift);

  // also push a small chat-bubble like donate note
  try{
    const note = document.createElement("div");
    note.className = "gift-toast";
    const em = gift.emoji || (GIFT_CLIENT_CATALOG[gift.type]?.emoji) || "ğŸ";
    note.textContent = `${em} ${donor || "Ai Ä‘Ã³"} táº·ng +${gift.coins || 0} coin`;
    document.body.appendChild(note);
    setTimeout(()=>note.classList.add("hide"), 1600);
    setTimeout(()=>{ try{note.remove();}catch{} }, 2300);
  }catch{}
});

const walletCoinsEl = document.getElementById("walletCoins");
socket.on("wallet-sync", ({ coins }) => { if (walletCoinsEl) walletCoinsEl.textContent = String(coins ?? 0); });
socket.on("wallet-update", ({ coins }) => { if (walletCoinsEl) walletCoinsEl.textContent = String(coins ?? 0); });

socket.on("gift-failed", ({ reason, need, coins })=>{
  if (reason === "no_coins"){
    
  }
});

const giftTotalCoinsEl = document.getElementById("giftTotalCoins");
const giftTopList = document.getElementById("giftTopList");
socket.on("gift-stats", ({ totalCoins, topDonors })=>{
  if (giftTotalCoinsEl) giftTotalCoinsEl.textContent = String(totalCoins ?? 0);
  if (giftTopList){
    const arr = Array.isArray(topDonors) ? topDonors : [];
    giftTopList.innerHTML = arr.length
      ? arr.map((d,i)=>`<div class="gift-board__row"><span>#${i+1} ${d.name}</span><b>${d.coins}</b></div>`).join("")
      : `<div class="gift-board__empty">ChÆ°a cÃ³ donate</div>`;
  }
});
// ===== NEON CONFIRM: Back to Lobby (VIEWER) =====
const ncf = document.getElementById("neonConfirm");
const ncfBg = ncf?.querySelector(".ncf__bg");
const ncfOk = document.getElementById("ncfOk");
const ncfCancel = document.getElementById("ncfCancel");
const ncfX = document.getElementById("ncfX");

function openNcf(){
  if (!ncf) return;
  ncf.classList.remove("hidden");
  ncf.setAttribute("aria-hidden", "false");
  setTimeout(()=>{ try{ ncfOk?.focus(); }catch{} }, 0);
}
function closeNcf(){
  if (!ncf) return;
  ncf.classList.add("hidden");
  ncf.setAttribute("aria-hidden", "true");
}

// nÃºt quay vá» lobby (Ä‘Ã£ cÃ³)
const btnBackLobby = document.getElementById("btnBackLobby");
btnBackLobby?.addEventListener("click", () => openNcf());

// click ná»n / X / Cancel => Ä‘Ã³ng
ncfBg?.addEventListener("click", closeNcf);
ncfX?.addEventListener("click", closeNcf);
ncfCancel?.addEventListener("click", closeNcf);

// ESC Ä‘Ã³ng
document.addEventListener("keydown", (e)=>{
  if (!ncf || ncf.classList.contains("hidden")) return;
  if (e.key === "Escape") closeNcf();
});

// OK => ngáº¯t socket nháº¹ nhÃ ng + vá» lobby
ncfOk?.addEventListener("click", () => {
  try { if (typeof socket !== "undefined" && socket) socket.disconnect(); } catch {}
  window.location.href = "/lobby.html";   // náº¿u home cá»§a báº¡n lÃ  lobby
  // window.location.href = "/lobby.html"; // náº¿u báº¡n dÃ¹ng file trá»±c tiáº¿p
});



socket.on("host-profile-update", (profile) => {
  document.querySelectorAll(".host-name")
    .forEach(el => el.textContent = profile.name);

  document.querySelectorAll(".host-avatar")
    .forEach(img => img.src = getAvatarByName(profile.name));
});

const chatFab = document.getElementById("chatFab");
const chatInputOverlay = document.getElementById("chatInputOverlay");
const quickChatInput = document.getElementById("quickChatInput");
const quickChatSend = document.getElementById("quickChatSend");

// âœ… iOS/Android: pháº£i focus trong cÃ¹ng â€œuser gestureâ€
function openQuickChat(){
  chatInputOverlay.classList.remove("hidden");
  quickChatInput.focus({ preventScroll: false });
  quickChatInput.click();         // âœ… Ã©p báº­t keyboard (Android)
  quickChatInput.scrollIntoView({ block:"nearest" });
}

function closeQuickChat(){
  chatInputOverlay.classList.add("hidden");
  quickChatInput.blur();
}

chatFab?.addEventListener("pointerdown", (e) => {
  e.preventDefault();
  e.stopPropagation();

  if (chatInputOverlay.classList.contains("hidden")) openQuickChat();
  else closeQuickChat();
});

quickChatSend?.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  sendQuickChat();
});

quickChatInput?.addEventListener("keydown", (e)=>{
  if (e.key === "Enter") sendQuickChat();
});

function sendQuickChat(){
  const text = (quickChatInput.value || "").trim();
  if (!text) return;

  socket.emit("chat", {
    roomId,
    name: (chatName?.value || "User").trim(),
    text,
    // role tÃ¹y trang báº¡n set:
    // role: "host" / "viewer" / "guest"
  });

  quickChatInput.value = "";
  closeQuickChat();
}


function showKickModal(text){
  const modal = document.getElementById("neonConfirm");
  document.getElementById("ncfTitle").textContent = "Livestream Ä‘Ã£ káº¿t thÃºc";

  modal.classList.remove("hidden");

  let sec = 5;
  const timer = setInterval(() => {
    document.getElementById("ncfTitle").textContent =
      `Host Ä‘Ã£ rá»i phÃ²ng â€¢ vá» Lobby sau ${sec}s`;
    sec--;
    if (sec < 0) {
      clearInterval(timer);
      location.href = "/lobby.html";
    }
  }, 1000);
}

socket.on("room-closed", ({ reason }) => {

   document.body.classList.remove("is-live");

  showKickModal("Host Ä‘Ã£ káº¿t thÃºc livestream");
});




  // Cháº·n pinch zoom (iOS)
  document.addEventListener("gesturestart", e => e.preventDefault());
  document.addEventListener("gesturechange", e => e.preventDefault());
  document.addEventListener("gestureend", e => e.preventDefault());

  // Cháº·n Ctrl + scroll zoom (PC)
  document.addEventListener("wheel", e => {
    if (e.ctrlKey) e.preventDefault();
  }, { passive: false });


const giftFab = document.getElementById("giftFab");
const giftPanel = document.getElementById("giftPanel");

giftFab?.addEventListener("click", (e)=>{
  e.stopPropagation();
  giftPanel.classList.toggle("hidden");
});

// click ngoÃ i â†’ Ä‘Ã³ng
document.addEventListener("click", ()=>{
  giftPanel.classList.add("hidden");
});
giftPanel?.addEventListener("click", e=>e.stopPropagation());

// gá»­i quÃ  (Ä‘Ãºng format server)
giftPanel?.querySelectorAll("button[data-gift]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const type = btn.dataset.gift;

    // láº¥y tÃªn giá»‘ng gift-bar Ä‘ang dÃ¹ng
    const name = (chatName?.value || "Viewer").trim().slice(0,20);

    // láº¥y combo giá»‘ng há»‡ Ä‘ang cÃ³ (x1/x5/x10)
    const qty = Math.max(1, Math.min(999, Number(__giftCombo || 1) || 1));

  

    giftPanel.classList.add("hidden");
  });
});


function getUserProfile(){
  const p = localStorage.getItem("user_profile");
  if (!p) return null;
  try { return JSON.parse(p); }
  catch { return null; }
}

const profile = getUserProfile();
if (profile){
  const chatNameInput = document.getElementById("chatName");
  if (chatNameInput) {
    chatNameInput.value = profile.name;
    chatNameInput.disabled = true; // ğŸ”’ khÃ³a khÃ´ng cho sá»­a
  }
}


socket.on("host-temp-offline", () => {
  statusBadge.textContent = "âš ï¸ Host máº¥t káº¿t ná»‘i táº¡m thá»i...";
});

socket.on("host-back-online", () => {
  statusBadge.textContent = "ğŸ”´ Äang LIVE";
});

socket.on("host-live", ({ liveStartTs }) => {
  joinViewerStream();
  statusBadge.textContent = "ğŸ”´ Äang LIVE";
  startLiveTimer(liveStartTs);
});

setInterval(() => {
  if (player.srcObject && player.readyState < 2) {
    console.warn("ğŸ”„ Video stalled â†’ retry play");
    forcePlayVideo(player);
  }
}, 2000);


setInterval(() => {
  const st = player.srcObject;
  if (!st) return;

  const at = st.getAudioTracks()[0];
  if (!at || at.readyState !== "live") {
    console.warn("ğŸ”„ Audio dead â†’ request ICE restart");
    socket.emit("request-ice-restart", {
      to: hostId,
      reason: "audio_lost"
    });
  }
}, 3000);


setInterval(() => {
  if (!player || !player.srcObject) return;

  const st = player.srcObject;

  const v = st.getVideoTracks()[0];
  const a = st.getAudioTracks()[0];

  // náº¿u track cháº¿t â†’ xin host ICE restart
  if ((v && v.readyState !== "live") || (a && a.readyState !== "live")) {
    console.warn("ğŸ§Š Viewer detect dead track â†’ request ICE restart");
    socket.emit("request-ice-restart", {
      to: hostId,
      reason: "tab background recover"
    });
  }
}, 4000);

setInterval(() => {
  if (joined) return;
  if (!document.body.classList.contains("is-live")) return;

  console.warn("â³ Viewer still waiting â†’ retry join");
  join().catch(()=>{});
}, 4000);


window.addEventListener("beforeunload", () => {
  const overlay = document.getElementById("reconnectOverlay");
  if (!overlay) return;
  overlay.classList.remove("hidden");

  const text = overlay.querySelector(".reconnect-text");
  if (text) text.textContent = "Äang táº£i láº¡i livestreamâ€¦";
});



  </script>

<!-- VIP TICKER (donation banner) -->
<div id="vipTicker" class="vip-ticker" aria-live="polite"></div>

</body>
</html>
