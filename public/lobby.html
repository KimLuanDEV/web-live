<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Lobby - Livestream Pro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./style.css">
</head>
<body class="lobby-page">
  <div class="container lobby-shell">
    <div class="card lobby-hero">
      <div class="topbar" style="margin-bottom:6px">
        <div class="brand">
          <span class="brand__dot"></span>
          <div>
            <div class="brand__title">ğŸŸï¸ Sáº¢NH LIVE</div>
            <small>Danh sÃ¡ch host Ä‘ang LIVE â€¢ click Ä‘á»ƒ vÃ o xem</small>
          </div>
        </div>

        <div class="pills">
          <button class="btn lobby-btn" id="btnOpenCreate">â• Táº¡o phÃ²ng</button>
          <button id="refresh" class="lobby-btn" title="LÃ m má»›i">ğŸ”„</button>
        </div>
      </div>

      <div class="lobby-controls">
        <div class="lobby-searchWrap">
          <div class="lobby-searchIcon">ğŸ”</div>
          <input id="q" class="lobby-search" placeholder="TÃ¬m theo Room ID hoáº·c tÃªn host..." autocomplete="off" />
          <button id="clearQ" class="lobby-clear" title="XÃ³a tÃ¬m kiáº¿m" aria-label="XÃ³a">âœ•</button>
        </div>

        <div class="lobby-filters">
          <button class="lobby-chipBtn is-active" data-filter="all">Táº¥t cáº£</button>
          <button class="lobby-chipBtn" data-filter="cohost">CÃ³ co-host</button>

          <select id="sort" class="lobby-select" title="Sáº¯p xáº¿p">
            <option value="viewers">ğŸ”¥ ÄÃ´ng ngÆ°á»i xem</option>
            <option value="new">ğŸ†• Má»›i live</option>
            <option value="old">â± Live lÃ¢u</option>
          </select>
        </div>

        <div class="lobby-stats" aria-live="polite">
          <div class="lobby-stat">
            <div class="lobby-statLabel">PhÃ²ng Ä‘ang live</div>
            <div class="lobby-statVal" id="statRooms">0</div>
          </div>
          <div class="lobby-stat">
            <div class="lobby-statLabel">Tá»•ng viewers</div>
            <div class="lobby-statVal" id="statViewers">0</div>
          </div>
          <div class="lobby-stat lobby-stat--right">
            <div class="lobby-statLabel">Cáº­p nháº­t</div>
            <div class="lobby-statVal lobby-statTime" id="statTs">--:--:--</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div id="empty" class="log">ChÆ°a cÃ³ phÃ²ng nÃ o Ä‘ang live.</div>

      <!-- skeleton loading -->
      <div id="skeleton" class="lobby-grid" style="display:none"></div>

      <div id="grid" class="lobby-grid"></div>
    </div>
  </div>

<!-- CREATE ROOM MODAL -->
<div id="createRoomModal" class="modal hidden">
  <div class="modal-backdrop"></div>

  <div class="modal-card">
    <h3>ğŸ¥ Táº¡o phÃ²ng livestream</h3>

    <label>Room ID (viáº¿t liá»n khÃ´ng dáº¥u)</label>
    <input id="roomInput" placeholder="vd: abc123" />

    <label>TÃªn Host</label>
    <input id="hostNameInput" placeholder="TÃªn hiá»ƒn thá»‹" />

    <div class="modal-actions">
      <button id="btnCancelRoom" type="button">Há»§y</button>
      <button id="btnConfirmRoom" type="button">ğŸš€ VÃ o phÃ²ng</button>
    </div>
  </div>
</div>


<!-- WELCOME MODAL (NEON) -->
<div id="welcomeModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
  <div class="modal-backdrop modal-backdrop--neon"></div>

  <div class="neon-modal" tabindex="-1">
    <div class="neon-frame"></div>
    <div class="neon-scan"></div>

    <div class="neon-top">
      <div class="neon-livePill">
        <span class="neon-dot"></span>
        <span>LIVE LOBBY</span>
      </div>

      <button id="btnWelcomeX" class="neon-x" type="button" aria-label="ÄÃ³ng">âœ•</button>
    </div>

    <div class="neon-hero">
      <div class="neon-titleWrap">
        <div class="neon-kicker">ğŸŸï¸ Sáº¢NH LIVE</div>
        <h3 id="welcomeTitle" class="neon-title">ChÃ o má»«ng Ä‘áº¿n Livestream Pro</h3>
        <div class="neon-sub">
          Xem host Ä‘ang LIVE theo thá»i gian thá»±c â€¢ táº¡o phÃ²ng Ä‘á»ƒ lÃªn live trong 5 giÃ¢y
        </div>
      </div>

      <div class="neon-badges">
        <div class="neon-chip">âš¡ Real-time</div>
        <div class="neon-chip">ğŸ’¬ Chat + Reaction</div>
        <div class="neon-chip">ğŸ¤ Xin lÃªn live</div>
      </div>
    </div>

    <div class="neon-grid">
      <div class="neon-card">
        <div class="neon-ic">ğŸ‘€</div>
        <div>
          <div class="neon-cardTitle">VÃ o xem siÃªu nhanh</div>
          <div class="neon-cardText">Click phÃ²ng Ä‘ang live â†’ vÃ o Viewer ngay.</div>
        </div>
      </div>

      <div class="neon-card">
        <div class="neon-ic">ğŸ¥</div>
        <div>
          <div class="neon-cardTitle">Táº¡o phÃ²ng trong Lobby</div>
          <div class="neon-cardText">Nháº­p Room ID + tÃªn host â†’ chuyá»ƒn sang Host.</div>
        </div>
      </div>

      <div class="neon-card">
        <div class="neon-ic">âœ¨</div>
        <div>
          <div class="neon-cardTitle">Tráº£i nghiá»‡m neon</div>
          <div class="neon-cardText">Giao diá»‡n LED/Glow, cáº£m giÃ¡c â€œsÃ¢n kháº¥uâ€.</div>
        </div>
      </div>
    </div>

    <div class="neon-actions">
      <label class="neon-check">
        <input type="checkbox" id="welcomeDontShow" />
        <span>KhÃ´ng hiá»‡n láº¡i</span>
      </label>

      <div class="neon-btns">
        <button id="btnWelcomeClose" class="neon-btn neon-btn--ghost" type="button">Äá»ƒ sau</button>
        <button id="btnWelcomeCreate" class="neon-btn neon-btn--main" type="button">â• Táº¡o phÃ²ng ngay</button>
      </div>
    </div>
  </div>
</div>


<!-- NEON ERROR MODAL -->
<div id="errorModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="modal-backdrop modal-backdrop--neon"></div>

  <div class="neon-modal neon-modal--error" tabindex="-1">
    <div class="neon-frame"></div>
    <div class="neon-scan"></div>

    <div class="neon-top">
      <div class="neon-livePill neon-livePill--error">
        <span class="neon-dot"></span>
        <span>Lá»–I Táº O PHÃ’NG</span>
      </div>
      <button id="btnErrorX" class="neon-x" aria-label="ÄÃ³ng">âœ•</button>
    </div>

    <div class="neon-hero">
      <h3 class="neon-title" style="color:#ff5c7c">
        âŒ Room Ä‘Ã£ tá»“n táº¡i
      </h3>
      <div class="neon-sub">
        Room ID nÃ y Ä‘ang Ä‘Æ°á»£c sá»­ dá»¥ng hoáº·c Ä‘ang LIVE.<br>
        Vui lÃ²ng chá»n ID khÃ¡c.
      </div>
    </div>

    <div class="neon-actions">
      <button id="btnErrorOk" class="neon-btn neon-btn--main">
        ğŸ” Nháº­p Room khÃ¡c
      </button>
    </div>
  </div>
</div>




<!-- COUNTDOWN OVERLAY -->
<div id="countdownOverlay" class="cd-overlay hidden" aria-hidden="true">
  <div class="cd-bg"></div>

  <div class="cd-panel">
    <div class="cd-ring"></div>

    <div class="cd-title">ğŸ¥ Äang vÃ o phÃ²ng LIVE</div>
    <div class="cd-sub" id="cdRoomText">Room: -</div>

    <div class="cd-number" id="cdNumber">3</div>

    <div class="cd-hint">Chuáº©n bá»‹ chuyá»ƒn sang Hostâ€¦</div>
  </div>
</div>


<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

// ===== WELCOME MODAL (NEON) =====
const welcomeModal = document.getElementById("welcomeModal");
const btnWelcomeClose = document.getElementById("btnWelcomeClose");
const btnWelcomeCreate = document.getElementById("btnWelcomeCreate");
const btnWelcomeX = document.getElementById("btnWelcomeX");
const welcomeDontShow = document.getElementById("welcomeDontShow");

function openWelcome(){ welcomeModal?.classList.remove("hidden"); }
function closeWelcome(){ welcomeModal?.classList.add("hidden"); }

(function showWelcomeOnce(){
  const off = localStorage.getItem("lobby_welcome_off") === "1";
  if (!off) openWelcome();
})();

function rememberIfChecked(){
  if (welcomeDontShow?.checked) localStorage.setItem("lobby_welcome_off","1");
}

welcomeModal?.querySelector(".modal-backdrop")?.addEventListener("click", ()=>{
  rememberIfChecked();
  closeWelcome();
});

btnWelcomeClose?.addEventListener("click", ()=>{
  rememberIfChecked();
  closeWelcome();
});

btnWelcomeX?.addEventListener("click", ()=>{
  rememberIfChecked();
  closeWelcome();
});

btnWelcomeCreate?.addEventListener("click", ()=>{
  rememberIfChecked();
  closeWelcome();

  // má»Ÿ modal táº¡o phÃ²ng náº¿u báº¡n Ä‘Ã£ lÃ m (id nÃºt táº¡o phÃ²ng trong lobby)
  const btnOpenCreate = document.getElementById("btnOpenCreate");
  if (btnOpenCreate) btnOpenCreate.click();
});

document.addEventListener("keydown", (e)=>{
  if (!welcomeModal || welcomeModal.classList.contains("hidden")) return;
  if (e.key === "Escape") { rememberIfChecked(); closeWelcome(); }
});



// ===== CREATE ROOM MODAL =====
const modal = document.getElementById("createRoomModal");
const btnOpenCreate = document.getElementById("btnOpenCreate");
const btnCancelRoom = document.getElementById("btnCancelRoom");
const btnConfirmRoom = document.getElementById("btnConfirmRoom");

const roomInput = document.getElementById("roomInput");
const hostNameInput = document.getElementById("hostNameInput");

function openModal(){
  modal.classList.remove("hidden");
  roomInput.value = "";
  hostNameInput.value = "";
  setTimeout(()=>roomInput.focus(), 0);
}
function closeModal(){
  modal.classList.add("hidden");
}

btnOpenCreate?.addEventListener("click", (e)=>{
  e.preventDefault();
  openModal();
});

btnCancelRoom?.addEventListener("click", closeModal);

// click ná»n Ä‘á»ƒ táº¯t
modal?.querySelector(".modal-backdrop")?.addEventListener("click", closeModal);

// Enter Ä‘á»ƒ xÃ¡c nháº­n
modal?.addEventListener("keydown", (e)=>{
  if (e.key === "Escape") closeModal();
  if (e.key === "Enter") btnConfirmRoom.click();
});


// ===== NEON ERROR MODAL =====
const errorModal = document.getElementById("errorModal");
const btnErrorOk = document.getElementById("btnErrorOk");
const btnErrorX  = document.getElementById("btnErrorX");

function openErrorModal(){
  if (!errorModal) return;
  errorModal.classList.remove("hidden");
  setTimeout(()=> roomInput?.focus(), 0);
}

function closeErrorModal(){
  if (!errorModal) return;
  errorModal.classList.add("hidden");
}

// click ná»n Ä‘á»ƒ Ä‘Ã³ng
errorModal?.querySelector(".modal-backdrop")
  ?.addEventListener("click", closeErrorModal);

btnErrorOk?.addEventListener("click", closeErrorModal);
btnErrorX?.addEventListener("click", closeErrorModal);

document.addEventListener("keydown", (e)=>{
  if (!errorModal || errorModal.classList.contains("hidden")) return;
  if (e.key === "Escape") closeErrorModal();
});



// ===== COUNTDOWN OVERLAY HELPERS =====
const countdownOverlay = document.getElementById("countdownOverlay");
const cdNumber = document.getElementById("cdNumber");
const cdRoomText = document.getElementById("cdRoomText");

function showCountdownOverlay(room){
  if (!countdownOverlay) return;
  cdRoomText && (cdRoomText.textContent = `Room: ${room}`);
  cdNumber && (cdNumber.textContent = "3");
  countdownOverlay.classList.remove("hidden");
  countdownOverlay.setAttribute("aria-hidden","false");
}

function hideCountdownOverlay(){
  if (!countdownOverlay) return;
  countdownOverlay.classList.add("hidden");
  countdownOverlay.setAttribute("aria-hidden","true");
}

// ===== REPLACE confirm handler =====
btnConfirmRoom?.addEventListener("click", ()=>{
  const room = (roomInput.value || "").trim().toLowerCase(); // â­

  const name = (hostNameInput.value || "").trim();

  if(!room){
    alert("âš ï¸ Vui lÃ²ng nháº­p Room ID");
    roomInput.focus();
    return;
  }

  // ğŸ‘‰ CHECK TRÃ™NG ROOM TRÆ¯á»šC
  socket.emit("check-room-available", { roomId: room }, (res)=>{
    if (res.reason === "EXIST") {
  openErrorModal();
}


    // ===== ROOM OK â†’ Má»šI CHO VÃ€O =====
    const url = `/broadcast.html?room=${encodeURIComponent(room)}&name=${encodeURIComponent(name || "Host")}`;

    btnConfirmRoom.classList.add("is-loading");
    if (btnCancelRoom) btnCancelRoom.disabled = true;
    roomInput.disabled = true;
    hostNameInput.disabled = true;

    showCountdownOverlay(room);

    let n = 3;
    cdNumber && (cdNumber.textContent = String(n));

    const timer = setInterval(()=>{
      n--;
      cdNumber && (cdNumber.textContent = String(n));

      if (n <= 0){
        clearInterval(timer);
        window.location.href = url;
      }
    }, 650);
  });
});




const grid = document.getElementById("grid");
const empty = document.getElementById("empty");
const skeleton = document.getElementById("skeleton");

const qEl = document.getElementById("q");
const clearQ = document.getElementById("clearQ");
const sortEl = document.getElementById("sort");

const statRooms = document.getElementById("statRooms");
const statViewers = document.getElementById("statViewers");
const statTs = document.getElementById("statTs");

let __rooms = [];
let __filter = "all";
let __q = "";
let __ts = null;

function pad(n){ return String(n).padStart(2,"0"); }
function hms(ms){
  const s = Math.floor(ms/1000);
  return `${pad(s/3600|0)}:${pad((s%3600)/60|0)}:${pad(s%60)}`;
}
function fmtTime(ts){
  const d = new Date(ts);
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}

function setActiveFilter(btn){
  document.querySelectorAll(".lobby-chipBtn").forEach(b=>b.classList.remove("is-active"));
  btn.classList.add("is-active");
}

function roomMatches(r, q){
  if (!q) return true;
  q = q.trim().toLowerCase();
  const roomId = String(r.roomId || "").toLowerCase();
  const hostName = String(r.host?.name || "").toLowerCase();
  return roomId.includes(q) || hostName.includes(q);
}

function applyFilterSort(list){
  let out = list.slice();

  // filter
  if (__filter === "cohost") out = out.filter(r => !!r.hasGuest);

  // search
  if (__q) out = out.filter(r => roomMatches(r, __q));

  // sort
  const mode = sortEl.value;
  if (mode === "viewers") {
    out.sort((a,b)=> (b.viewers - a.viewers) || (b.liveStartTs - a.liveStartTs));
  } else if (mode === "new") {
    out.sort((a,b)=> (b.liveStartTs - a.liveStartTs) || (b.viewers - a.viewers));
  } else if (mode === "old") {
    out.sort((a,b)=> (a.liveStartTs - b.liveStartTs) || (b.viewers - a.viewers));
  }
  return out;
}

function renderStats(list){
  const totalRooms = list.length;
  const totalViewers = list.reduce((s,r)=> s + (Number(r.viewers)||0), 0);

  statRooms.textContent = totalRooms;
  statViewers.textContent = totalViewers;
  statTs.textContent = __ts ? fmtTime(__ts) : "--:--:--";
}

function renderSkeleton(){
  skeleton.style.display = "grid";
  grid.style.display = "none";
  empty.style.display = "none";

  skeleton.innerHTML = "";
  for (let i=0;i<8;i++){
    const d = document.createElement("div");
    d.className = "lobby-skel";
    d.innerHTML = `
      <div class="lobby-skelHead">
        <div class="lobby-skelAva"></div>
        <div style="flex:1">
          <div class="lobby-skelLine w60"></div>
          <div class="lobby-skelLine w40" style="margin-top:8px"></div>
        </div>
        <div class="lobby-skelPill"></div>
      </div>
      <div class="lobby-skelRow">
        <div class="lobby-skelChip"></div>
        <div class="lobby-skelChip"></div>
      </div>
      <div class="lobby-skelLine w35" style="margin-top:12px"></div>
    `;
    skeleton.appendChild(d);
  }
}

function hideSkeleton(){
  skeleton.style.display = "none";
  grid.style.display = "";
}

function render(list){
  const show = applyFilterSort(list);
  renderStats(list);

  grid.innerHTML = "";
  empty.style.display = show.length ? "none" : "block";
  hideSkeleton();

  show.forEach(r => {
    const a = document.createElement("a");
    a.className = "lobby-card";
    a.href = `/viewer.html?room=${encodeURIComponent(r.roomId)}`;

    const hostName   = r.host?.name   || "Host";
    const hostAvatar = r.host?.avatar || `https://img.freepik.com/premium-vector/live-streaming-text-neon-sign-illustration_189374-265.jpg?w=360`;

    const liveFor = (typeof r.liveStartTs === "number") ? (Date.now() - r.liveStartTs) : 0;

    a.innerHTML = `
      <div class="lobby-cardGlow"></div>

      <div class="lobby-cardTop">
        <div class="lobby-host">
          <img class="lobby-ava" src="${hostAvatar}" alt="avatar" loading="lazy">
          <div class="lobby-hostinfo">
            <div class="lobby-hostname">${escapeHtml(hostName)}</div>
            <div class="lobby-roomid">ğŸ¥ ${escapeHtml(r.roomId)}</div>
          </div>
        </div>

        <div class="lobby-badges">
          <span class="lobby-livePill"><span class="lobby-liveDot"></span> LIVE</span>
          ${r.hasGuest ? `<span class="badge badge--info" style="margin:0">Co-host</span>` : ``}
        </div>
      </div>

      <div class="lobby-cardMeta">
        <span class="lobby-chip">ğŸ‘ <b>${Number(r.viewers)||0}</b></span>
        <span class="lobby-chip">â± <b>${hms(liveFor)}</b></span>
      </div>

      <div class="lobby-cardFoot">
        <div class="lobby-cta">VÃ o xem</div>
        <div class="lobby-arrow">âœ</div>
      </div>
    `;

    grid.appendChild(a);
  });
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ===== events ===== */
document.querySelectorAll(".lobby-chipBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    __filter = btn.dataset.filter || "all";
    setActiveFilter(btn);
    render(__rooms);
  });
});

sortEl.addEventListener("change", ()=> render(__rooms));

let __qTimer = null;
qEl.addEventListener("input", ()=>{
  clearTimeout(__qTimer);
  __qTimer = setTimeout(()=>{
    __q = qEl.value || "";
    clearQ.style.opacity = __q.trim() ? "1" : ".45";
    render(__rooms);
  }, 80);
});

clearQ.addEventListener("click", ()=>{
  qEl.value = "";
  __q = "";
  clearQ.style.opacity = ".45";
  render(__rooms);
  qEl.focus();
});

/* ===== socket ===== */
function requestLobby(){
  renderSkeleton();
  socket.emit("lobby-get");
}

socket.on("lobby-update", d => {
  __rooms = (d && d.rooms) ? d.rooms : [];
  __ts = d && d.ts ? d.ts : Date.now();
  render(__rooms);
});

document.getElementById("refresh").onclick = requestLobby;

// load
requestLobby();
setInterval(() => socket.emit("lobby-get"), 3000);




</script>








</body>
</html>
