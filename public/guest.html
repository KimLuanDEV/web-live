<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guest</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ‘¤ KhÃ¡ch má»i</h1>
      <hr />

      <div class="row">
        <div class="card">
          <div class="kv">
            <div class="badge">PhÃ²ng Livestream</div>
            <code id="roomCode">-</code>

            <div class="badge" id="statusBadge">â³ ChÆ°a báº­t cam/mic</div>
            <button id="btnStart">Xin lÃªn live</button>
          </div>
          
<div style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap">
  <button id="btnFlipCam" disabled>ğŸ”„ Äáº£o camera</button>
  <button id="btnLeaveLive" disabled>ğŸšª Rá»i live</button>
</div>

          <hr />
          <div class="log" id="log" style="display: none;"></div>
        </div>

        <div class="card">

       
   
          <div class="video-card" style="margin-top:10px">
            <div class="live-overlay">
              <span class="dot"></span>
              <b>KhÃ¡ch má»i</b>
              <span style="opacity:.85"></span>
            </div>

            <div class="video-card__inner">
              <video id="me" autoplay playsinline muted></video>
            </div>

              <div class="av-controls">
  <button id="guestMicBtn" class="av-btn">ğŸ™ï¸</button>
  <button id="guestCamBtn" class="av-btn">ğŸ“·</button>
</div>
          </div>

          <hr />
          <div class="badge badge--info">ğŸ”Š/ğŸ¥ Host</div>
          <div class="video-card" style="margin-top:10px">
            <div class="pin-overlay" id="pinOverlay" hidden></div>

<div class="chat-overlay" id="chatOverlay"></div>

          <div class="video-card__inner">
              <video id="hostVideo" autoplay playsinline controls></video>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<hr />
<div class="card chat">
  <div class="badge badge--info">ğŸ’¬ Chat (Live)</div>

  <div class="chatform">
    <input id="chatName" value="KhÃ¡ch" />
    <input id="chatText" placeholder="Nháº­p tin nháº¯n..." />
    <button id="chatSend" class="full">Gá»­i</button>
  </div>

  <div class="emoji-bar" id="emojiBar">
    <button type="button" class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸</button>
    <button type="button" class="emoji-btn" data-emoji="ğŸ”¥">ğŸ”¥</button>
    <button type="button" class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
    <button type="button" class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
    <button type="button" class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
    <button type="button" class="emoji-btn" data-emoji="ğŸ˜®">ğŸ˜®</button>
    <button type="button" class="emoji-btn" data-emoji="ğŸ˜¢">ğŸ˜¢</button>
  </div>


  <div id="chatBox" class="chatbox"></div>
</div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const logEl = document.getElementById("log");
    const badge = document.getElementById("statusBadge");
    const me = document.getElementById("me");
    const hostVideo = document.getElementById("hostVideo");
    const btnStart = document.getElementById("btnStart");

    const btnFlipCam = document.getElementById("btnFlipCam");
    const btnLeaveLive = document.getElementById("btnLeaveLive");

    const params = new URLSearchParams(location.search);
    const roomId = params.get("room") || "abc123";
    document.getElementById("roomCode").textContent = roomId;

    const socket = io();
    let localStream = null;
    const pcs = new Map(); // peerId -> RTCPeerConnection

    let currentFacing = "user"; // user (cam trÆ°á»›c) | environment (cam sau)

    async function getRtcConfig() {
      const fallback = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
      try {
        const r = await fetch("/ice", { cache: "no-store" });
        if (!r.ok) return fallback;
        const data = await r.json();
        if (!data.iceServers || !Array.isArray(data.iceServers)) return fallback;

        const cleanedIceServers = data.iceServers
          .map(server => {
            let urls = server.urls;
            if (!urls) return null;
            if (!Array.isArray(urls)) urls = [urls];
            const safeUrls = urls.filter(u =>
              typeof u === "string" &&
              !(u.startsWith("stun:") && u.includes("?transport="))
            );
            if (safeUrls.length === 0) return null;
            return { ...server, urls: safeUrls };
          })
          .filter(Boolean);

        if (cleanedIceServers.length === 0) return fallback;
        return { iceServers: cleanedIceServers };
      } catch (e) {
        console.error(e);
        return fallback;
      }
    }

    function log(msg) {
      logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
      console.log(msg);
    }
    function setStatus(t){ badge.textContent = t; }

    btnStart.onclick = async () => {
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: currentFacing } },
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });
        me.srcObject = localStream;

        socket.emit("join-room", { roomId, role: "guest" });
        setStatus("â³ ÄÃ£ báº­t cam/mic. Äang chá» host duyá»‡t...");
        log("ÄÃ£ xin lÃªn live, chá» host duyá»‡t...");

        // báº­t nÃºt Ä‘iá»u khiá»ƒn guest
        btnFlipCam.disabled = false;
        btnLeaveLive.disabled = false;
      } catch (e) {
        alert("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera/mic: " + e.message);
      }
    };

    socket.on("guest-pending", () => setStatus("â³ Äang chá» host duyá»‡t..."));
    socket.on("guest-rejected", () => setStatus("â›” Host tá»« chá»‘i."));
    socket.on("guest-approved", () => {
      setStatus("âœ… ÄÆ°á»£c duyá»‡t! Báº¡n Ä‘ang lÃªn live.");
      log("ÄÆ°á»£c duyá»‡t! BÃ¢y giá» viewer/host sáº½ káº¿t ná»‘i tá»›i báº¡n.");
    });

    // When someone wants to watch guest, guest creates offer to them
    socket.on("guest-watcher", async ({ viewerId }) => {
      if (!localStream) return;
      if (pcs.has(viewerId)) return;

      log("Táº¡o káº¿t ná»‘i tá»›i: " + viewerId);

      const rtcConfig = await getRtcConfig();
      const pc = new RTCPeerConnection(rtcConfig);
      pcs.set(viewerId, pc);

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.onicecandidate = (e) => {
        if (e.candidate) socket.emit("candidate", { to: viewerId, candidate: e.candidate });
      };

      // Receive host stream (host will addTrack when answering)
      pc.ontrack = (e) => {
        hostVideo.srcObject = e.streams[0];
        hostVideo.play().catch(() => {});
      };

      pc.oniceconnectionstatechange = () => log(`ICE(${viewerId}): ${pc.iceConnectionState}`);

      try {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.emit("offer", { to: viewerId, description: pc.localDescription });
      } catch (err) {
        log("Lá»—i táº¡o offer: " + err.message);
      }
    });

    socket.on("answer", async ({ from, description }) => {
      const pc = pcs.get(from);
      if (!pc) return;
      try { await pc.setRemoteDescription(description); }
      catch (err) { log("Lá»—i setRemoteDescription(answer): " + err.message); }
    });

    socket.on("candidate", async ({ from, candidate }) => {
      const pc = pcs.get(from);
      if (!pc) return;
      try { await pc.addIceCandidate(candidate); }
      catch (err) { log("Lá»—i addIceCandidate: " + err.message); }
    });

    // ===== GUEST: FLIP CAMERA + LEAVE LIVE =====
async function flipCamera() {
  if (!localStream) return;
  currentFacing = (currentFacing === "user") ? "environment" : "user";
  log("ğŸ”„ Äang Ä‘áº£o camera: " + (currentFacing === "user" ? "TRÆ¯á»šC" : "SAU"));

  try {
    const newStream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: currentFacing } },
      audio: false
    });
    const newVideoTrack = newStream.getVideoTracks()[0];
    if (!newVideoTrack) throw new Error("KhÃ´ng láº¥y Ä‘Æ°á»£c camera má»›i");

    const oldVideoTrack = localStream.getVideoTracks()[0];
    if (oldVideoTrack) {
      localStream.removeTrack(oldVideoTrack);
      oldVideoTrack.stop();
    }
    localStream.addTrack(newVideoTrack);

    // cáº­p nháº­t preview
    me.srcObject = localStream;

    // replaceTrack cho táº¥t cáº£ peer
    for (const pc of pcs.values()) {
      const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
      if (sender) await sender.replaceTrack(newVideoTrack);
      else pc.addTrack(newVideoTrack, localStream);
    }

    log("âœ… Äáº£o camera thÃ nh cÃ´ng");
  } catch (err) {
    // revert state Ä‘á»ƒ láº§n sau thá»­ láº¡i
    currentFacing = (currentFacing === "user") ? "environment" : "user";
    log("âŒ KhÃ´ng Ä‘áº£o Ä‘Æ°á»£c camera: " + err.message);
    alert("KhÃ´ng Ä‘áº£o Ä‘Æ°á»£c camera: " + err.message);
  }
}

function leaveLive() {
  log("ğŸšª Rá»i live...");

  // Ä‘Ã³ng táº¥t cáº£ peer
  for (const pc of pcs.values()) { try { pc.close(); } catch {} }
  pcs.clear();

  // táº¯t cam/mic
  if (localStream) {
    try { localStream.getTracks().forEach(t => t.stop()); } catch {}
    localStream = null;
  }

  // disable controls
  btnFlipCam.disabled = true;
  btnLeaveLive.disabled = true;

  // ngáº¯t socket Ä‘á»ƒ server nháº­n disconnect -> guest-offline
  try { socket.disconnect(); } catch {}

  // vá» viewer
  location.href = "/viewer.html?room=" + encodeURIComponent(roomId);
}

btnFlipCam.onclick = flipCamera;
btnLeaveLive.onclick = leaveLive;

window.addEventListener("beforeunload", () => {
      for (const pc of pcs.values()) { try { pc.close(); } catch {} }
      pcs.clear();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
    });

    // ===== CHAT =====
    const chatBox = document.getElementById("chatBox");
    const chatName = document.getElementById("chatName");
    const chatText = document.getElementById("chatText");
    const chatSend = document.getElementById("chatSend");

    function roleLabel(role){
      if (role === "broadcaster") return "HOST";
      if (role === "guest") return "GUEST";
      return "VIEWER";
    }
    function roleClass(role){
      if (role === "broadcaster") return "role-host";
      if (role === "guest") return "role-guest";
      return "role-viewer";
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }



    
    function addChat(msg) {
      const time = new Date(msg.ts).toLocaleTimeString();
      const line = document.createElement("div");
      line.className = "chatline";

      const meta = document.createElement("span");
      meta.className = "chatline__meta " + roleClass(msg.role);
      meta.textContent = `[${time}] ${roleLabel(msg.role)} â€¢ ${msg.name}: `;

      const text = document.createElement("span");
      text.className = "chatline__text";
      text.textContent = msg.text;

      line.appendChild(meta);
      line.appendChild(text);

      // host can pin/unpin
      if (false) {
        const pinBtn = document.createElement("button");
        pinBtn.className = "pin-btn";
        pinBtn.type = "button";
        pinBtn.textContent = "ğŸ“Œ";
        pinBtn.title = "Ghim tin nháº¯n lÃªn video";
        pinBtn.onclick = () => socket.emit("chat-pin", { roomId, msg });
        line.appendChild(pinBtn);
      }

      chatBox.appendChild(line);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on("chat", (msg)=>{ addChat(msg); pushOverlay(msg); });

    // pinned message (room-wide)
    const pinOverlay = document.getElementById("pinOverlay");
    socket.on("chat-pinned", ({ msg }) => {
      if (!pinOverlay) return;
      if (!msg) {
        pinOverlay.hidden = true;
        pinOverlay.innerHTML = "";
        return;
      }
      pinOverlay.hidden = false;
      pinOverlay.className = "pin-overlay " + roleClass(msg.role);
      pinOverlay.innerHTML = `<b>ğŸ“Œ ${roleLabel(msg.role)} â€¢ ${msg.name}:</b> <span>${escapeHtml(msg.text)}</span>`;
    });


    // ===== CHAT OVERLAY + EMOJI QUICK BAR ===== // CHAT OVERLAY
    const chatOverlay = document.getElementById("chatOverlay");
    
    function pushOverlay(msg){
      if (!chatOverlay) return;
      const el = document.createElement("div");
      el.className = "chat-bubble " + roleClass(msg.role);
      el.textContent = `${roleLabel(msg.role)} â€¢ ${msg.name}: ${msg.text}`;
      chatOverlay.appendChild(el);

      while (chatOverlay.children.length > 4) chatOverlay.removeChild(chatOverlay.firstChild);

      setTimeout(() => el.classList.add("hide"), 2600);
      setTimeout(() => { try { el.remove(); } catch {} }, 3200);
    }

    // add emoji buttons
    const emojiBar = document.getElementById("emojiBar");
    if (emojiBar) {
      emojiBar.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-emoji]");
        if (!btn) return;
        const em = btn.getAttribute("data-emoji") || "";
        chatText.value = (chatText.value || "") + em;
        chatText.focus();
      });
    }


    chatSend.onclick = () => {
      const name = (chatName.value || "KhÃ¡ch").trim();
      const text = chatText.value.trim();
      if (!text) return;

      // client-side spam filter
      const now = Date.now();
      window.__chatAntiSpam = window.__chatAntiSpam || { lastTs: 0, lastText: "", burstStart: 0, burstCount: 0 };
      const s = window.__chatAntiSpam;

      if (now - s.lastTs < 650) return;                // too fast
      if (s.lastText === text && now - s.lastTs < 5000) return;  // repeat
      if (!s.burstStart || now - s.burstStart > 10000) { s.burstStart = now; s.burstCount = 0; }
      s.burstCount++;
      if (s.burstCount > 6) return; // too many in 10s

      s.lastTs = now;
      s.lastText = text;

      socket.emit("chat", { roomId, name, text });
      chatText.value = "";
    };


    // ===== GUEST AV TOGGLE =====
const guestMicBtn = document.getElementById("guestMicBtn");
const guestCamBtn = document.getElementById("guestCamBtn");

let guestMicOn = true;
let guestCamOn = true;

function toggleGuestMic(){
  if (!localStream) return;
  const track = localStream.getAudioTracks()[0];
  if (!track) return;

  guestMicOn = !guestMicOn;
  track.enabled = guestMicOn;
  guestMicBtn.classList.toggle("off", !guestMicOn);
  guestMicBtn.textContent = guestMicOn ? "ğŸ™ï¸" : "ğŸ”‡";
}

function toggleGuestCam(){
  if (!localStream) return;
  const track = localStream.getVideoTracks()[0];
  if (!track) return;

  guestCamOn = !guestCamOn;
  track.enabled = guestCamOn;
  guestCamBtn.classList.toggle("off", !guestCamOn);
  guestCamBtn.textContent = guestCamOn ? "ğŸ“·" : "ğŸš«";
}

guestMicBtn.onclick = toggleGuestMic;
guestCamBtn.onclick = toggleGuestCam;

// Host yÃªu cáº§u guest táº¯t/báº­t mic
socket.on("guest-set-mic", ({ mute }) => {
  if (!localStream) return;
  const at = localStream.getAudioTracks()[0];
  if (!at) return;

  at.enabled = !mute;

  // náº¿u báº¡n cÃ³ icon mic cá»§a guest thÃ¬ cáº­p nháº­t luÃ´n:
  if (typeof guestMicBtn !== "undefined" && guestMicBtn) {
    guestMicBtn.classList.toggle("off", !!mute);
    guestMicBtn.textContent = mute ? "ğŸ”‡" : "ğŸ™ï¸";
  }
});

// Host kick guest
socket.on("guest-kicked", () => {
  alert("Báº¡n Ä‘Ã£ bá»‹ Host kÃ­ch khá»i live.");
  // dÃ¹ng cÃ¹ng luá»“ng rá»i live Ä‘á»ƒ dá»n dáº¹p
  try { leaveLive(); } catch {
    location.href = "/viewer.html?room=" + encodeURIComponent(roomId);
  }
});


  </script>
</body>
</html>
