<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Guest</title>
  <link rel="stylesheet" href="/style.css" />
<style>
/* AV icon controls overlay */
.video-stage{ position:relative; }
.av-controls{
  position:absolute;
  right:10px;
  bottom:10px;
  display:flex;
  gap:10px;
  z-index:5;
}
.av-btn{
  width:44px;
  height:44px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.22);
  background: rgba(0,0,0,.55);
  color:#fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  backdrop-filter: blur(8px);
}
.av-btn:disabled{ opacity:.45; cursor:not-allowed; }
.av-btn.on{ box-shadow: 0 0 22px rgba(37,240,154,.18); }
.av-btn.off{ box-shadow: 0 0 22px rgba(255,59,107,.18); }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ¤ GUEST (Xin lÃªn live)</h1>
      <small>Room: <b id="roomLbl"></b></small>
      <hr/>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button id="btnStart">Báº­t camera + mic & Xin lÃªn live</button>
        <button id="btnMic" disabled>ğŸ”‡ Táº¯t mic</button>
        <button id="btnCam" disabled>ğŸ“· Táº¯t camera</button>
        <button id="btnStop" disabled>Stop</button>
      </div>

      <div style="margin-top:10px" class="badge" id="status">â³ ChÆ°a báº­t cam</div>

      <hr/>
      <div class="row">
        <div class="card">
          <div class="badge">ğŸ¥ Báº¡n (Guest)</div>
          <div class="video-wrap video-stage" style="margin-top:10px">
            <video id="me" autoplay playsinline muted></video>
            <div class="av-controls">
              <button id="btnMicIcon" class="av-btn on" title="Mic" disabled>ğŸ™ï¸</button>
              <button id="btnCamIcon" class="av-btn on" title="Camera" disabled>ğŸ“·</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="badge">ğŸ§ Host (Ä‘á»ƒ trÃ² chuyá»‡n)</div>
          <div class="video-wrap" style="margin-top:10px">
            <video id="hostVideo" autoplay playsinline controls></video>
          </div>
        </div>
      </div>

      <hr/>
      <div class="badge">ğŸ’¬ Chat</div>
      <div style="margin-top:10px">
        <input id="chatName" value="Guest" />
        <input id="chatText" placeholder="Nháº­p tin nháº¯n..." style="margin-top:8px" />
        <button id="chatSend" style="margin-top:8px">Gá»­i</button>
      </div>
      <pre id="chatBox" class="log" style="margin-top:10px; max-height:220px; overflow:auto"></pre>

      <hr/>
      <div class="badge">ğŸ§¾ Log</div>
      <pre id="log" class="log" style="margin-top:10px; max-height:220px; overflow:auto"></pre>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const params = new URLSearchParams(location.search);
    const roomId = params.get("room") || "abc123";
    document.getElementById("roomLbl").textContent = roomId;

    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");
    const btnMic = document.getElementById("btnMic");
    const btnCam = document.getElementById("btnCam");
    const btnMicIcon = document.getElementById("btnMicIcon");
    const btnCamIcon = document.getElementById("btnCamIcon");
    const statusEl = document.getElementById("status");
    const logEl = document.getElementById("log");

    const me = document.getElementById("me");
    const hostVideo = document.getElementById("hostVideo");

    // chat
    const chatBox = document.getElementById("chatBox");
    const chatName = document.getElementById("chatName");
    const chatText = document.getElementById("chatText");
    const chatSend = document.getElementById("chatSend");

    function log(msg){
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }
    function setStatus(t){ statusEl.textContent = t; }

    async function getRtcConfig() {
      const fallback = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
      try {
        const r = await fetch("/ice", { cache: "no-store" });
        if (!r.ok) return fallback;
        const data = await r.json();
        if (!data.iceServers || !Array.isArray(data.iceServers)) return fallback;

        const cleaned = data.iceServers.map(s => {
          let urls = s.urls;
          if (!Array.isArray(urls)) urls = [urls];
          urls = urls.filter(u => !(typeof u === "string" && u.startsWith("stun:") && u.includes("?transport=")));
          return { ...s, urls };
        }).filter(s => s.urls && (Array.isArray(s.urls) ? s.urls.length : true));

        return { iceServers: cleaned.length ? cleaned : fallback.iceServers };
      } catch { return fallback; }
    }

    let localStream = null;
    let micMuted = false;
    let camOff = false;
    const pcs = new Map(); // peerId -> pc (host + many viewers)

    btnStart.onclick = async () => {
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        me.srcObject = localStream;

        btnStart.disabled = true;
        btnStop.disabled = false;
        btnMic.disabled = false;
      btnCam.disabled = false;
      if (btnMicIcon) btnMicIcon.disabled = false;
      if (btnCamIcon) btnCamIcon.disabled = false;
      micMuted = false; camOff = false;
      setMicMuted(false);
      setCamOff(false);

        socket.emit("join-room", { roomId, role: "guest" });
        setStatus("â³ Äang chá» host duyá»‡t...");
        log("Guest join-room");
      } catch (e) {
        alert("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera/mic: " + e.message);
      }
    };

    btnStop.onclick = () => {
      for (const pc of pcs.values()) { try{ pc.close(); }catch{} }
      pcs.clear();

      if (localStream) localStream.getTracks().forEach(t => t.stop());
      localStream = null;
      me.srcObject = null;
      hostVideo.srcObject = null;

      btnStart.disabled = false;
      btnStop.disabled = true;
      btnMic.disabled = true;
      btnCam.disabled = true;
      if (btnMicIcon) btnMicIcon.disabled = true;
      if (btnCamIcon) btnCamIcon.disabled = true;
      micMuted = false;
      btnMic.textContent = "ğŸ”‡ Táº¯t mic";
      setStatus("ÄÃ£ dá»«ng");
    };

    function setMicMuted(mute) {
      if (!localStream) return;
      const at = localStream.getAudioTracks()[0];
      if (!at) return;
      at.enabled = !mute;
      micMuted = mute;
      btnMic.textContent = micMuted ? "ğŸ™ï¸ Báº­t mic" : "ğŸ”‡ Táº¯t mic";
      if (btnMicIcon) {
        btnMicIcon.textContent = micMuted ? "ğŸ”‡" : "ğŸ™ï¸";
        btnMicIcon.classList.toggle("off", micMuted);
        btnMicIcon.classList.toggle("on", !micMuted);
      }
      log(micMuted ? "ÄÃ£ táº¯t mic" : "ÄÃ£ báº­t mic");
    }
        function setCamOff(off) {
      if (!localStream) return;
      const vt = localStream.getVideoTracks()[0];
      if (!vt) return;
      camOff = !!off;
      vt.enabled = !camOff;
      btnCam.textContent = camOff ? "ğŸ“· Báº­t camera" : "ğŸ“· Táº¯t camera";
      if (btnCamIcon) {
        btnCamIcon.textContent = camOff ? "ğŸš«" : "ğŸ“·";
        btnCamIcon.classList.toggle("off", camOff);
        btnCamIcon.classList.toggle("on", !camOff);
      }
      log(camOff ? "ÄÃ£ táº¯t camera" : "ÄÃ£ báº­t camera");
    }

btnMic.onclick = () => setMicMuted(!micMuted);
    btnCam.onclick = () => setCamOff(!camOff);
    if (btnMicIcon) btnMicIcon.onclick = () => setMicMuted(!micMuted);
    if (btnCamIcon) btnCamIcon.onclick = () => setCamOff(!camOff);

    socket.on("guest-pending", () => setStatus("â³ Äang chá» host duyá»‡t..."));
    socket.on("guest-rejected", () => setStatus("â›” Host tá»« chá»‘i."));
    socket.on("guest-approved", () => setStatus("âœ… ÄÆ°á»£c duyá»‡t! NgÆ°á»i xem sáº½ tháº¥y báº¡n."));

    // server tells guest: someone wants to watch guest -> guest creates offer to that viewer/host
    socket.on("guest-watcher", async ({ viewerId }) => {
      if (!localStream) return;
      if (pcs.has(viewerId)) return;

      const rtc = await getRtcConfig();
      const pc = new RTCPeerConnection(rtc);
      pcs.set(viewerId, pc);

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.onicecandidate = (e) => {
        if (e.candidate) socket.emit("candidate", { to: viewerId, candidate: e.candidate });
      };

      // Host sends tracks back to guest (for conversation) -> we render it
      pc.ontrack = (e) => {
        hostVideo.srcObject = e.streams[0];
        hostVideo.play().catch(()=>{});
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer", { to: viewerId, description: pc.localDescription });

      log("ÄÃ£ gá»­i offer tá»›i: " + viewerId);
    });

    socket.on("answer", async ({ from, description }) => {
      const pc = pcs.get(from);
      if (!pc) return;
      await pc.setRemoteDescription(description);
    });

    socket.on("candidate", async ({ from, candidate }) => {
      const pc = pcs.get(from);
      if (!pc) return;
      try { await pc.addIceCandidate(candidate); } catch(e){}
    });

    // chat
    function addChat(msg){
      const t = new Date(msg.ts).toLocaleTimeString();
      chatBox.textContent += `[${t}] ${msg.name}: ${msg.text}\n`;
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    socket.on("chat", addChat);

    chatSend.onclick = () => {
      const name = (chatName.value || "Guest").trim();
      const text = chatText.value.trim();
      if (!text) return;
      socket.emit("chat", { roomId, name, text });
      chatText.value = "";
    };
  </script>
</body>
</html>
