<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Broadcast</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ“± Broadcast (NgÆ°á»i phÃ¡t)</h1>
      <small>Má»Ÿ trÃªn Ä‘iá»‡n thoáº¡i vÃ  báº¥m Start Ä‘á»ƒ phÃ¡t live.</small>
      <hr />

      <div class="row">
        <div class="card">
          <div class="kv">
            <div class="badge">PhÃ²ng</div>
            <code id="roomCode">-</code>

            <div class="badge">Link xem</div>
            <code id="viewerLink">-</code>
            <button id="copyViewer">Copy link xem</button>

            <hr />
            <button id="btnStart">Start Camera + Mic</button>
            <button id="btnStop" disabled>Stop</button>
            <button id="btnFlip" disabled>ğŸ”„ Äáº£o Camera</button>

          </div>
          <hr />
          <div class="log" id="log"></div>
        </div>

        <div class="card">
         <div class="video-card" style="margin-top:10px">
  <div class="live-overlay">
    <span class="dot"></span>
    <b>HOST</b>
    <span style="opacity:.85"></span>
  </div>

  <hr />
<div class="card">
  <div class="badge">ğŸ‘¤ Guest xin lÃªn live</div>
  <div id="guestReq" class="log" style="margin-top:10px">ChÆ°a cÃ³ yÃªu cáº§u.</div>
  <button id="btnApproveGuest" disabled>âœ… Cháº¥p nháº­n Guest</button>
  <button id="btnRejectGuest" disabled>âŒ Tá»« chá»‘i</button>

  <hr />
  <div class="badge">ğŸ¥ Video Guest</div>
  <div class="video-wrap" style="margin-top:10px">
    <video id="guestVideo" autoplay playsinline controls></video>
  </div>
</div>

  <div class="video-card__inner">
    <video id="preview" autoplay playsinline muted></video>
  </div>
</div>

      </div>
    </div>
  </div>

<hr />
<div class="card chat">
  <div class="badge badge--info">ğŸ’¬ Chat (Live)</div>

  <div class="chatform">
    <input id="chatName" value="Host" />
    <input id="chatText" placeholder="Nháº­p tin nháº¯n..." />
    <button id="chatSend" class="full">Gá»­i</button>
  </div>

  <div id="chatBox" class="chatbox"></div>
</div>


  
  <script src="/socket.io/socket.io.js"></script>
  <script>

const guestReq = document.getElementById("guestReq");
const btnApproveGuest = document.getElementById("btnApproveGuest");
const btnRejectGuest  = document.getElementById("btnRejectGuest");
const guestVideo = document.getElementById("guestVideo");

let pendingGuestId = null;
let pcGuestIn = null; // PC Ä‘á»ƒ nháº­n video tá»« guest



    const logEl = document.getElementById("log");
    const preview = document.getElementById("preview");
    const btnStart = document.getElementById("btnStart");
    const btnStop = document.getElementById("btnStop");


    const btnFlip = document.getElementById("btnFlip");
    let currentFacing = "user"; // "user" (cam trÆ°á»›c) | "environment" (cam sau)

    const params = new URLSearchParams(location.search);
    const roomId = params.get("room") || "abc123";

    document.getElementById("roomCode").textContent = roomId;

    const viewerUrl = `${location.origin}/viewer.html?room=${encodeURIComponent(roomId)}`;
    document.getElementById("viewerLink").textContent = viewerUrl;
    document.getElementById("copyViewer").onclick = async () => {
      try { await navigator.clipboard.writeText(viewerUrl); alert("ÄÃ£ copy link xem!"); }
      catch { prompt("Copy thá»§ cÃ´ng:", viewerUrl); }
    };

    const socket = io();
    let localStream = null;

    // One RTCPeerConnection per viewer
    const pcs = new Map();

    // STUN server (demo). TURN sáº½ cáº§n náº¿u máº¡ng khÃ³ (4G/Carrier NAT)
async function getRtcConfig() {
  const fallback = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  };

  try {
    const r = await fetch("/ice", { cache: "no-store" });
    if (!r.ok) return fallback;

    const data = await r.json();
    if (!data.iceServers || !Array.isArray(data.iceServers)) return fallback;

    // ğŸ”¥ FIX CHÃNH á» ÄÃ‚Y
    const cleanedIceServers = data.iceServers
      .map(server => {
        let urls = server.urls;
        if (!urls) return null;

        if (!Array.isArray(urls)) urls = [urls];

        // âŒ LOáº I Bá» STUN TWILIO CÃ“ ?transport=
        const safeUrls = urls.filter(u =>
          typeof u === "string" &&
          !(u.startsWith("stun:") && u.includes("?transport="))
        );

        if (safeUrls.length === 0) return null;

        return {
          ...server,
          urls: safeUrls
        };
      })
      .filter(Boolean);

    if (cleanedIceServers.length === 0) return fallback;

    return { iceServers: cleanedIceServers };

  } catch (e) {
    console.error("ICE fetch error:", e);
    return fallback;
  }
}



socket.on("guest-request", ({ guestId }) => {
  pendingGuestId = guestId;
  guestReq.textContent = "GuestID: " + guestId + " (báº¥m Cháº¥p nháº­n Ä‘á»ƒ guest lÃªn live)";
  btnApproveGuest.disabled = false;
  btnRejectGuest.disabled = false;
});

btnApproveGuest.onclick = () => {
  if (!pendingGuestId) return;
  socket.emit("guest-approve", { roomId, guestId: pendingGuestId });
  guestReq.textContent = "ÄÃ£ cháº¥p nháº­n guest: " + pendingGuestId;
};

btnRejectGuest.onclick = () => {
  if (!pendingGuestId) return;
  socket.emit("guest-reject", { guestId: pendingGuestId });
  guestReq.textContent = "ÄÃ£ tá»« chá»‘i guest.";
  pendingGuestId = null;
  btnApproveGuest.disabled = true;
  btnRejectGuest.disabled = true;
};

socket.on("guest-online", ({ guestId }) => {
  // host cÅ©ng xem guest Ä‘á»ƒ nÃ³i chuyá»‡n
  socket.emit("watch-guest", { roomId });
});
socket.on("guest-offline", () => {
  if (pcGuestIn) { try{ pcGuestIn.close(); }catch{} pcGuestIn = null; }
  guestVideo.srcObject = null;
  guestReq.textContent = "Guest Ä‘Ã£ rá»i.";
});

socket.on("offer", async ({ from, description }) => {
  // offer nÃ y cÃ³ thá»ƒ Ä‘áº¿n tá»« guest (vÃ¬ viewer khÃ´ng gá»­i offer tá»›i host)
  // reset pcGuestIn
  if (pcGuestIn) { try{ pcGuestIn.close(); }catch{} }
  const rtcConfig = await getRtcConfig();
  pcGuestIn = new RTCPeerConnection(rtcConfig);

  // host gá»­i láº¡i audio/video cá»§a host cho guest Ä‘á»ƒ nÃ³i chuyá»‡n 2 chiá»u
  if (localStream) {
    localStream.getTracks().forEach(t => pcGuestIn.addTrack(t, localStream));
  }

  pcGuestIn.ontrack = (e) => {
    guestVideo.srcObject = e.streams[0];
  };

  pcGuestIn.onicecandidate = (e) => {
    if (e.candidate) socket.emit("candidate", { to: from, candidate: e.candidate });
  };

  await pcGuestIn.setRemoteDescription(description);
  const answer = await pcGuestIn.createAnswer();
  await pcGuestIn.setLocalDescription(answer);
  socket.emit("answer", { to: from, description: pcGuestIn.localDescription });
});

    function log(msg) {
      logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + logEl.textContent;
      console.log(msg);
    }

    socket.emit("join-room", { roomId, role: "broadcaster" });

    socket.on("watcher", async ({ viewerId }) => {
      if (!localStream) {
        log("CÃ³ viewer nhÆ°ng báº¡n chÆ°a Start camera.");
        return;
      }
      log(`Viewer join: ${viewerId}`);

      const rtcConfig = await getRtcConfig();
      const pc = new RTCPeerConnection(rtcConfig);



      pcs.set(viewerId, pc);

      // Add tracks
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = (e) => {
        if (e.candidate) {
          socket.emit("candidate", { to: viewerId, candidate: e.candidate });
        }
      };

      pc.oniceconnectionstatechange = () => {
        log(`ICE(${viewerId}): ${pc.iceConnectionState}`);
      };

      try {
        const offer = await pc.createOffer({ offerToReceiveAudio: false, offerToReceiveVideo: false });
        await pc.setLocalDescription(offer);
        socket.emit("offer", { to: viewerId, description: pc.localDescription });
      } catch (err) {
        log("Lá»—i táº¡o offer: " + err.message);
      }
    });

    socket.on("answer", async ({ from, description }) => {
      const pc = pcs.get(from);
      if (!pc) return;
      try {
        await pc.setRemoteDescription(description);
        log(`Nháº­n answer tá»« viewer: ${from}`);
      } catch (err) {
        log("Lá»—i setRemoteDescription(answer): " + err.message);
      }
    });

    socket.on("candidate", async ({ from, candidate }) => {
      const pc = pcs.get(from);
      if (!pc) return;
      try {
        await pc.addIceCandidate(candidate);
      } catch (err) {
        log("Lá»—i addIceCandidate: " + err.message);
      }
    });

    socket.on("disconnectPeer", ({ peerId }) => {
      const pc = pcs.get(peerId);
      if (pc) {
        pc.close();
        pcs.delete(peerId);
        log(`Viewer rá»i: ${peerId} -> close peer`);
      }
    });

    socket.on("broadcaster-changed", () => {
      log("CÃ³ broadcaster má»›i trong phÃ²ng (Ä‘ang lÃ  báº¡n).");
    });

    async function start() {
      if (localStream) return;

      // Mobile best practice: request via user gesture (button click)
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: currentFacing }},
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });

        preview.srcObject = localStream;
        btnStart.disabled = true;
        btnStop.disabled = false;
        btnFlip.disabled = false;

        log("ÄÃ£ Start camera + mic. Gá»­i link xem cho ngÆ°á»i khÃ¡c.");

        socket.emit("broadcaster-ready", { roomId });

        // Náº¿u viewers Ä‘Ã£ vÃ o trÆ°á»›c, server sáº½ gá»­i danh sÃ¡ch
        // MÃ¬nh sáº½ yÃªu cáº§u há» reload báº±ng broadcaster-online Ä‘Ã£ Ä‘á»§.
      } catch (err) {
        log("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera/mic: " + err.message);
        alert("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera/mic. Náº¿u trÃªn Ä‘iá»‡n thoáº¡i: cáº§n HTTPS.");
      }
    }

    function stop() {
      if (!localStream) return;

      // close all peers
      for (const [id, pc] of pcs.entries()) {
        pc.close();
        pcs.delete(id);
      }

      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
      preview.srcObject = null;

      btnStart.disabled = false;
      btnStop.disabled = true;

      log("ÄÃ£ Stop.");
    }

    btnStart.onclick = start;
    btnStop.onclick = stop;
    btnFlip.disabled = true;

    // cleanup on close
    window.addEventListener("beforeunload", stop);

    // ===== CHAT (BROADCAST) =====
const chatBox = document.getElementById("chatBox");
const chatName = document.getElementById("chatName");
const chatText = document.getElementById("chatText");
const chatSend = document.getElementById("chatSend");

function addChat(msg) {
  const time = new Date(msg.ts).toLocaleTimeString();
  chatBox.textContent += `[${time}] ${msg.name}: ${msg.text}\n`;
  chatBox.scrollTop = chatBox.scrollHeight;
}

socket.on("chat", addChat);

chatSend.onclick = () => {
  const name = (chatName.value || "Host").trim();
  const text = chatText.value.trim();
  if (!text) return;

  socket.emit("chat", { roomId, name, text });
  chatText.value = "";
};

function addChat(msg) {
  const time = new Date(msg.ts).toLocaleTimeString();
  const line = document.createElement("div");
  line.textContent = `[${time}] ${msg.name}: ${msg.text}`;
  chatBox.appendChild(line);
  chatBox.scrollTop = chatBox.scrollHeight;
}

async function flipCamera() {
  if (!localStream) return;

  // Ä‘á»•i hÆ°á»›ng camera
  currentFacing = (currentFacing === "user") ? "environment" : "user";
  log("Äang Ä‘á»•i camera sang: " + (currentFacing === "user" ? "CAM TRÆ¯á»šC" : "CAM SAU"));

  try {
    const newStream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: currentFacing } },
      audio: false // audio giá»¯ nguyÃªn Ä‘á»ƒ khÃ´ng giáº­t tiáº¿ng
    });

    const newVideoTrack = newStream.getVideoTracks()[0];
    if (!newVideoTrack) throw new Error("KhÃ´ng láº¥y Ä‘Æ°á»£c video track má»›i");

    // 1) thay track trong localStream hiá»‡n táº¡i
    const oldVideoTrack = localStream.getVideoTracks()[0];
    if (oldVideoTrack) {
      localStream.removeTrack(oldVideoTrack);
      oldVideoTrack.stop();
    }
    localStream.addTrack(newVideoTrack);

    // 2) cáº­p nháº­t preview
    preview.srcObject = localStream;

    // 3) quan trá»ng: thay track cho Táº¤T Cáº¢ peer connections Ä‘ang stream tá»›i viewers
    for (const [viewerId, pc] of pcs.entries()) {
      const sender = pc.getSenders().find(s => s.track && s.track.kind === "video");
      if (sender) {
        await sender.replaceTrack(newVideoTrack);
      } else {
        // fallback: náº¿u khÃ´ng tÃ¬m tháº¥y sender (hiáº¿m), addTrack láº¡i
        pc.addTrack(newVideoTrack, localStream);
      }
      log(`ÄÃ£ Ä‘á»•i camera cho viewer: ${viewerId}`);
    }

    log("âœ… Äá»•i camera thÃ nh cÃ´ng.");
  } catch (err) {
    log("âŒ Äá»•i camera tháº¥t báº¡i: " + err.message);
    // náº¿u lá»—i, revert tráº¡ng thÃ¡i Ä‘á»ƒ láº§n sau thá»­ láº¡i Ä‘Ãºng
    currentFacing = (currentFacing === "user") ? "environment" : "user";
    alert("KhÃ´ng Ä‘á»•i Ä‘Æ°á»£c camera. HÃ£y kiá»ƒm tra quyá»n camera hoáº·c thá»­ trÃ¬nh duyá»‡t khÃ¡c.");
  }
}

btnFlip.onclick = () => {
  flipCamera();
};


  </script>
</body>
</html>
