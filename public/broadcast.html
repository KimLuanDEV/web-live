<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Broadcast</title>
  <link rel="stylesheet" href="/style.css" />
<style>
/* AV icon controls overlay */
.video-stage{ position:relative; }
.av-controls{
  position:absolute;
  right:10px;
  bottom:10px;
  display:flex;
  gap:10px;
  z-index:5;
}
.av-btn{
  width:44px;
  height:44px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.22);
  background: rgba(0,0,0,.55);
  color:#fff;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  backdrop-filter: blur(8px);
}
.av-btn:disabled{ opacity:.45; cursor:not-allowed; }
.av-btn.on{ box-shadow: 0 0 22px rgba(37,240,154,.18); }
.av-btn.off{ box-shadow: 0 0 22px rgba(255,59,107,.18); }
</style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>ğŸ“¡ LIVESTREAM (HOST)</h1>
      <small>Room: <b id="roomLbl"></b></small>
      <hr/>

      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button id="btnStart">Start Camera + Mic</button>
        <button id="btnStop" disabled>Stop</button>
        <button id="btnMic" disabled>ğŸ”‡ Táº¯t mic</button>
        <button id="btnCam" disabled>ğŸ“· Táº¯t camera</button>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap">
        <div class="badge">ğŸ‘€ Viewers: <span id="viewerCount">0</span></div>
        <div class="badge">Tráº¡ng thÃ¡i: <span id="status">-</span></div>
      </div>

      <hr/>

      <div class="row">
        <div class="card">
          <div class="badge">ğŸ¥ Preview (Host)</div>
          <div class="video-wrap video-stage" style="margin-top:10px">
            <video id="preview" autoplay playsinline muted></video>
            <div class="av-controls">
              <button id="btnMicIcon" class="av-btn on" title="Mic" disabled>ğŸ™ï¸</button>
              <button id="btnCamIcon" class="av-btn on" title="Camera" disabled>ğŸ“·</button>
            </div>
          </div>

          <hr/>
          <div class="badge">ğŸ‘¤ Guest</div>
          <div id="guestReq" class="log" style="margin-top:10px">ChÆ°a cÃ³ guest xin lÃªn live.</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
            <button id="btnApproveGuest" disabled>âœ… Cháº¥p nháº­n Guest</button>
            <button id="btnRejectGuest" disabled>âŒ Tá»« chá»‘i</button>
          </div>
          <div class="video-wrap" style="margin-top:10px">
            <video id="guestVideo" autoplay playsinline controls></video>
          </div>

          <hr/>
          <div class="badge">ğŸ”— Link share</div>
          <code id="links" style="margin-top:10px"></code>
        </div>

        <div class="card">
          <div class="badge">ğŸ’¬ Chat</div>
          <div style="margin-top:10px">
            <input id="chatName" value="Host" />
            <input id="chatText" placeholder="Nháº­p tin nháº¯n..." style="margin-top:8px" />
            <button id="chatSend" style="margin-top:8px">Gá»­i</button>
          </div>
          <pre id="chatBox" class="log" style="margin-top:10px; max-height:240px; overflow:auto"></pre>

          <hr/>
          <div class="badge">ğŸ§¾ Log</div>
          <pre id="log" class="log" style="margin-top:10px; max-height:240px; overflow:auto"></pre>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    const params = new URLSearchParams(location.search);
    const roomId = params.get("room") || "abc123";

    const roomLbl = document.getElementById("roomLbl");
    const btnStart = document.getElementById("btnStart");
    const btnStop  = document.getElementById("btnStop");
    const btnMic   = document.getElementById("btnMic");
    const preview  = document.getElementById("preview");
    const guestVideo = document.getElementById("guestVideo");
    const viewerCount = document.getElementById("viewerCount");
    const statusEl = document.getElementById("status");
    const linksEl = document.getElementById("links");
    const logEl = document.getElementById("log");

    const guestReq = document.getElementById("guestReq");
    const btnApproveGuest = document.getElementById("btnApproveGuest");
    const btnRejectGuest  = document.getElementById("btnRejectGuest");

    // chat
    const chatBox = document.getElementById("chatBox");
    const chatName = document.getElementById("chatName");
    const chatText = document.getElementById("chatText");
    const chatSend = document.getElementById("chatSend");

    roomLbl.textContent = roomId;
    linksEl.textContent =
      "Viewer: " + location.origin + "/viewer.html?room=" + encodeURIComponent(roomId) + "\n" +
      "Guest:  " + location.origin + "/guest.html?room=" + encodeURIComponent(roomId);

    function log(msg){
      logEl.textContent += msg + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }
    function setStatus(t){ statusEl.textContent = t; }

    async function getRtcConfig() {
      const fallback = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
      try {
        const r = await fetch("/ice", { cache: "no-store" });
        if (!r.ok) return fallback;
        const data = await r.json();
        if (!data.iceServers || !Array.isArray(data.iceServers)) return fallback;

        // lá»c stun twilio lá»—i '?transport=' (phÃ²ng há»)
        const cleaned = data.iceServers.map(s => {
          let urls = s.urls;
          if (!Array.isArray(urls)) urls = [urls];
          urls = urls.filter(u => !(typeof u === "string" && u.startsWith("stun:") && u.includes("?transport=")));
          return { ...s, urls };
        }).filter(s => s.urls && (Array.isArray(s.urls) ? s.urls.length : true));

        return { iceServers: cleaned.length ? cleaned : fallback.iceServers };
      } catch { return fallback; }
    }

    let localStream = null;
    let micMuted = false;
    let camOff = false;

    const pcsToViewers = new Map(); // viewerId -> RTCPeerConnection
    let pendingGuestId = null;
    let pcGuestIn = null; // host receiving guest (and sending host back)

    socket.emit("join-room", { roomId, role: "broadcaster" });

    socket.on("viewer-count", ({ count }) => {
      viewerCount.textContent = count;
    });

    // viewers list (optional)
    socket.on("room-viewers", (viewerIds) => {
      log("Viewers trong phÃ²ng: " + viewerIds.length);
      // náº¿u host Ä‘Ã£ start rá»“i, táº¡o láº¡i offer cho viewer Ä‘Ã£ cÃ³
      viewerIds.forEach(id => createViewerPeer(id));
    });

    // viewer join -> host must send offer
    socket.on("watcher", async ({ viewerId }) => {
      log("Watcher: " + viewerId);
      await createViewerPeer(viewerId);
    });

    async function createViewerPeer(viewerId) {
      if (!localStream) return;
      if (pcsToViewers.has(viewerId)) return;

      const rtcConfig = await getRtcConfig();
      const pc = new RTCPeerConnection(rtcConfig);
      pcsToViewers.set(viewerId, pc);

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.onicecandidate = (e) => {
        if (e.candidate) socket.emit("candidate", { to: viewerId, candidate: e.candidate });
      };

      pc.oniceconnectionstatechange = () => {
        log("ICE(viewer " + viewerId + "): " + pc.iceConnectionState);
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("offer", { to: viewerId, description: pc.localDescription });
    }

    socket.on("answer", async ({ from, description }) => {
      // answer from viewers (or guest)
      const pcV = pcsToViewers.get(from);
      if (pcV) {
        await pcV.setRemoteDescription(description);
        return;
      }
      if (pcGuestIn && from === pendingGuestId) {
        await pcGuestIn.setRemoteDescription(description);
      }
    });

    socket.on("candidate", async ({ from, candidate }) => {
      const pcV = pcsToViewers.get(from);
      if (pcV) { try { await pcV.addIceCandidate(candidate); } catch(e){} return; }
      if (pcGuestIn && from === pendingGuestId) { try { await pcGuestIn.addIceCandidate(candidate); } catch(e){} }
    });

    socket.on("disconnectPeer", ({ peerId }) => {
      const pc = pcsToViewers.get(peerId);
      if (pc) { try{ pc.close(); }catch{} pcsToViewers.delete(peerId); }
    });

    // ===== Guest flow =====
    socket.on("guest-request", ({ guestId }) => {
      pendingGuestId = guestId;
      guestReq.textContent = "GuestID: " + guestId + " Ä‘ang xin lÃªn live.";
      btnApproveGuest.disabled = false;
      btnRejectGuest.disabled = false;
      log("Guest request: " + guestId);
    });

    btnApproveGuest.onclick = () => {
      if (!pendingGuestId) return;
      socket.emit("guest-approve", { roomId, guestId: pendingGuestId });
      guestReq.textContent = "âœ… ÄÃ£ cháº¥p nháº­n guest: " + pendingGuestId;
      // host cÅ©ng xem guest Ä‘á»ƒ trÃ² chuyá»‡n
      socket.emit("watch-guest", { roomId });
    };

    btnRejectGuest.onclick = () => {
      if (!pendingGuestId) return;
      socket.emit("guest-reject", { guestId: pendingGuestId });
      guestReq.textContent = "âŒ ÄÃ£ tá»« chá»‘i guest.";
      btnApproveGuest.disabled = true;
      btnRejectGuest.disabled = true;
      pendingGuestId = null;
    };

    socket.on("guest-online", ({ guestId }) => {
      pendingGuestId = guestId;
      guestReq.textContent = "ğŸŸ¢ Guest Ä‘ang online: " + guestId;
      // host cÅ©ng káº¿t ná»‘i tá»›i guest Ä‘á»ƒ nÃ³i chuyá»‡n
      socket.emit("watch-guest", { roomId });
    });

    socket.on("guest-offline", () => {
      guestReq.textContent = "Guest Ä‘Ã£ rá»i.";
      if (pcGuestIn) { try{ pcGuestIn.close(); }catch{} pcGuestIn = null; }
      guestVideo.srcObject = null;
      pendingGuestId = null;
    });

    // Host receives offers from GUEST (guest creates offers to watchers via server)
    socket.on("offer", async ({ from, description }) => {
      // Only guest should send offer to host in our design
      if (!pendingGuestId || from !== pendingGuestId) {
        // ignore unexpected offers
        log("Nháº­n offer láº¡ tá»« " + from + " -> bá» qua");
        return;
      }

      if (pcGuestIn) { try{ pcGuestIn.close(); }catch{} pcGuestIn = null; }

      const rtcConfig = await getRtcConfig();
      pcGuestIn = new RTCPeerConnection(rtcConfig);

      // send host tracks back to guest so they can talk
      if (localStream) {
        localStream.getTracks().forEach(t => pcGuestIn.addTrack(t, localStream));
      }

      pcGuestIn.ontrack = (e) => {
        guestVideo.srcObject = e.streams[0];
        log("ÄÃ£ nháº­n stream tá»« guest.");
      };

      pcGuestIn.onicecandidate = (e) => {
        if (e.candidate) socket.emit("candidate", { to: from, candidate: e.candidate });
      };

      await pcGuestIn.setRemoteDescription(description);
      const answer = await pcGuestIn.createAnswer();
      await pcGuestIn.setLocalDescription(answer);
      socket.emit("answer", { to: from, description: pcGuestIn.localDescription });
      log("ÄÃ£ gá»­i answer cho guest.");
    });

    // ===== Start/Stop + Mic toggle =====
    btnStart.onclick = async () => {
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({
          video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: "user" } },
          audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }
        });
        preview.srcObject = localStream;
        setStatus("Äang LIVE");
        log("Start camera + mic OK");

        btnStart.disabled = true;
        btnStop.disabled = false;
        btnMic.disabled = false;
      btnCam.disabled = false;
      if (btnMicIcon) btnMicIcon.disabled = false;
      if (btnCamIcon) btnCamIcon.disabled = false;
      micMuted = false; camOff = false;
      setMicMuted(false);
      setCamOff(false);

        // create offers to any existing viewers
        // server will also send room-viewers earlier, but safe to do nothing here.
      } catch (e) {
        alert("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera/mic: " + e.message);
      }
    };

    btnStop.onclick = () => {
      for (const pc of pcsToViewers.values()) { try{ pc.close(); }catch{} }
      pcsToViewers.clear();

      if (pcGuestIn) { try{ pcGuestIn.close(); }catch{} pcGuestIn = null; }
      guestVideo.srcObject = null;

      if (localStream) localStream.getTracks().forEach(t => t.stop());
      localStream = null;
      preview.srcObject = null;

      btnStart.disabled = false;
      btnStop.disabled = true;
      btnMic.disabled = true;
      btnCam.disabled = true;
      if (btnMicIcon) btnMicIcon.disabled = true;
      if (btnCamIcon) btnCamIcon.disabled = true;
      micMuted = false;
      btnMic.textContent = "ğŸ”‡ Táº¯t mic";
      setStatus("ÄÃ£ dá»«ng");
      log("Stop");
    };

    function setMicMuted(mute) {
      if (!localStream) return;
      const at = localStream.getAudioTracks()[0];
      if (!at) return;
      at.enabled = !mute;
      micMuted = mute;
      btnMic.textContent = micMuted ? "ğŸ™ï¸ Báº­t mic" : "ğŸ”‡ Táº¯t mic";
      if (btnMicIcon) {
        btnMicIcon.textContent = micMuted ? "ğŸ”‡" : "ğŸ™ï¸";
        btnMicIcon.classList.toggle("off", micMuted);
        btnMicIcon.classList.toggle("on", !micMuted);
      }
      log(micMuted ? "ÄÃ£ táº¯t mic" : "ÄÃ£ báº­t mic");
    }

        function setCamOff(off) {
      if (!localStream) return;
      const vt = localStream.getVideoTracks()[0];
      if (!vt) return;
      camOff = !!off;
      vt.enabled = !camOff;
      btnCam.textContent = camOff ? "ğŸ“· Báº­t camera" : "ğŸ“· Táº¯t camera";
      if (btnCamIcon) {
        btnCamIcon.textContent = camOff ? "ğŸš«" : "ğŸ“·";
        btnCamIcon.classList.toggle("off", camOff);
        btnCamIcon.classList.toggle("on", !camOff);
      }
      log(camOff ? "ÄÃ£ táº¯t camera" : "ÄÃ£ báº­t camera");
    }

btnMic.onclick = () => setMicMuted(!micMuted);
    btnCam.onclick = () => setCamOff(!camOff);
    if (btnMicIcon) btnMicIcon.onclick = () => setMicMuted(!micMuted);
    if (btnCamIcon) btnCamIcon.onclick = () => setCamOff(!camOff);

    // ===== Chat =====
    function addChat(msg){
      const t = new Date(msg.ts).toLocaleTimeString();
      chatBox.textContent += `[${t}] ${msg.name}: ${msg.text}\n`;
      chatBox.scrollTop = chatBox.scrollHeight;
    }
    socket.on("chat", addChat);

    chatSend.onclick = () => {
      const name = (chatName.value || "Host").trim();
      const text = chatText.value.trim();
      if (!text) return;
      socket.emit("chat", { roomId, name, text });
      chatText.value = "";
    };
  </script>
</body>
</html>
